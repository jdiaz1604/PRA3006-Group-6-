<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Highlighting the correlation between endangered species and country's socioeconomic profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0b1020;
      --ink:#f2f4f8;
      --accent:#6fb1ff;
      --accent-strong:#8fe0f2;
      --muted:#a8b3c7;
      --panel:#121831;
      --panel-dark:#0c1226;
    }
    * { box-sizing:border-box; }
    html,body { margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; }
    body { min-height:100vh; }
    header { padding:18px 24px; border-bottom:1px solid #1e2748; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; }
    header h1 { margin:0; font-size:18px; line-height:1.3; }
    nav { display:flex; gap:12px; }
    nav a { color:var(--muted); text-decoration:none; font-size:14px; padding:6px 10px; border-radius:6px; border:1px solid transparent; }
    nav a:hover { color:var(--ink); border-color:#23305a; }

    main { display:flex; flex-direction:column; gap:40px; }
    .hero { padding:48px 24px 32px; background:var(--panel-dark); display:grid; gap:20px; text-align:left; }
    .hero h2 { margin:0; font-size:28px; line-height:1.2; }
    .hero p { margin:8px 0 0; max-width:640px; color:var(--muted); }
    .hero-actions { display:flex; gap:14px; flex-wrap:wrap; margin-top:16px; }

    .btn { border:none; border-radius:999px; padding:10px 20px; font-size:14px; font-weight:600; cursor:pointer; transition:background .2s, color .2s, border .2s; }
    .btn-primary { background:var(--accent); color:#05122b; }
    .btn-primary:hover { background:var(--accent-strong); }
    .btn-outline { background:transparent; color:var(--ink); border:1px solid #324170; }
    .btn-outline:disabled { opacity:0.4; cursor:not-allowed; }

    .explorer { padding:0 0 32px; }
    .section-heading { display:flex; justify-content:space-between; align-items:flex-start; padding:0 24px 16px; gap:16px; flex-wrap:wrap; }
    .section-heading h3 { margin:0; font-size:20px; }
    .section-heading p { margin:6px 0 0; color:var(--muted); font-size:14px; max-width:560px; }

    .app { display:grid; grid-template-columns: minmax(0,1.15fr) minmax(320px,0.85fr); min-height:480px; border-top:1px solid #1e2748; border-bottom:1px solid #1e2748; }
    @media (max-width:960px) {
      .app { grid-template-columns:1fr; }
      .sidebar { min-height:360px; border-left:none; border-top:1px solid #1e2748; }
    }
    .map-wrap { position:relative; background:#050a1c; }
    .map { width:100%; height:100%; display:block; }

    .sidebar { background:var(--panel); padding:22px 24px 32px; border-left:1px solid #1e2748; display:flex; flex-direction:column; gap:14px; }
    .panel-label { font-size:12px; text-transform:uppercase; letter-spacing:.1em; color:var(--muted); margin-bottom:4px; }
    .sidebar h2 { margin:0 0 4px; font-size:22px; }
    .sidebar .small { color:var(--muted); font-size:13px; margin:0; }
    .checklist { padding-left:18px; margin:8px 0; color:var(--muted); font-size:13px; }
    .checklist li { margin-bottom:4px; }

    .metric { margin:12px 0; }
    .metric-label { color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.04em; }
    .metric-value { font-size:22px; margin-top:4px; }
    .loading { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; background:transparent; }
    .spinner { width:42px; height:42px; border:4px solid #33406a; border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; }
    .tooltip { position:absolute; pointer-events:none; background:#0e1530; color:var(--ink); padding:6px 8px; border:1px solid #1f2a50; border-radius:6px; font-size:12px; box-shadow:0 6px 20px rgba(0,0,0,.25); opacity:0; transition:opacity .15s; }
    .note { margin-top:4px; color:var(--muted); font-size:12px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .legend { margin:10px 0 2px; font-size:12px; color:var(--muted); }
    .attribution { margin-top:8px; font-size:11px; color:var(--muted); }
    a, a:visited { color:var(--accent); text-decoration:none; }
    a:hover { text-decoration:underline; }
    .status { font-size:12px; color:var(--muted); margin-top:4px; }
    .err { color:#ff9aa2; }

    .map-root path { transition:fill .2s, opacity .2s; }
    .sphere { fill:#0a1029; stroke:#1b2551; stroke-width:1; }
    .continent { fill:#111935; stroke:#233569; stroke-width:0.9; cursor:pointer; }
    .continent:hover { fill:#1a2a55; }
    .continent-selected { fill:#2f4c93; stroke:#7ba3ff; }
    .continent-dim { opacity:0.25; }

    .countries-layer { opacity:0.05; pointer-events:none; transition:opacity .2s; }
    .countries-layer.active { opacity:1; pointer-events:auto; }
    .country { fill:#162145; stroke:#223064; stroke-width:0.5; cursor:pointer; }
    .country:hover { fill:#223166; }
    .country-muted { opacity:0.15; pointer-events:none; }
    .country-selected { fill:#3857b1 !important; stroke:#8cafff; stroke-width:1.4px; }

    #dataContext { font-size:13px; color:var(--muted); margin-top:4px; min-height:18px; }
  </style>
</head>
<body>
  <header>
    <h1>Highlighting the correlation between endangered species and the economic growth of countries</h1>
    <nav>
      <a href="#home">Home</a>
      <a href="#explorer">Explore the data</a>
    </nav>
  </header>

  <main>
    <section class="hero" id="home">
      <div>
        <h2>How do endangered endemic species track with income and population?</h2>
        <p>
          This experimental atlas connects biodiversity data from Wikidata with macroeconomic signals.
          Start from a continent-level overview, then zoom into individual countries to inspect the latest
          figures on endemic species, endangered endemic species, nominal GDP, and population.
        </p>
        <div class="hero-actions">
          <button class="btn btn-primary" id="startExploring">Explore the interactive map</button>
          <a class="btn btn-outline" href="https://github.com/topojson/world-atlas" target="_blank" rel="noopener">About the basemap</a>
        </div>
      </div>
    </section>

    <section class="explorer" id="explorer">
      <div class="section-heading">
        <div>
          <h3>Continent → country drill-down</h3>
          <p>Click a continent to see aggregated endemic and socioeconomic indicators, then select any country inside that continent for a focused profile.</p>
        </div>
        <button class="btn btn-outline" id="backToWorld" disabled>Back to continents</button>
      </div>

      <div class="app">
        <div class="map-wrap">
          <svg class="map"></svg>
          <div class="loading" id="loading" aria-hidden="true" style="display:none;"><div class="spinner"></div></div>
          <div class="tooltip" id="tooltip"></div>
        </div>
        <aside class="sidebar">
          <div class="panel-label" id="panelMode">Continent overview</div>
          <h2 id="country-title">Select a continent</h2>
          <p class="small" id="dataContext">Start at the continent level to unlock regional totals. Then click any highlighted country to drill into its latest data.</p>
          <ul class="checklist">
            <li>Total endemic species</li>
            <li>Endangered endemic species</li>
            <li>Latest nominal GDP (USD)</li>
            <li>Latest population</li>
          </ul>

          <div class="metric">
            <div class="metric-label">Total endemic species</div>
            <div class="metric-value" id="totalEndemic">—</div>
            <div class="status" id="endemicStatus"></div>
          </div>
          <div class="metric">
            <div class="metric-label">Endangered endemic species</div>
            <div class="metric-value" id="endangeredEndemic">—</div>
          </div>

          <div id="chart" style="margin:10px 0 6px;"></div>
          <div class="legend">Bar chart: endemic vs. endangered endemic</div>

          <div class="metric" style="margin-top:18px;">
            <div class="metric-label">Latest nominal GDP (USD)</div>
            <div class="metric-value" id="gdp">—</div>
            <div class="small" id="gdpYear"></div>
            <div class="status" id="gdpStatus"></div>
          </div>

          <div class="metric">
            <div class="metric-label">Latest population</div>
            <div class="metric-value" id="population">—</div>
            <div class="small" id="popYear"></div>
            <div class="status" id="popStatus"></div>
          </div>

          <div class="note">Data source: QLever Wikidata (live). Tables are fetched once and filtered client-side.</div>
          <div class="attribution">Map © <a href="https://github.com/topojson/world-atlas" target="_blank" rel="noopener">world-atlas</a> · Built with <a href="https://d3js.org/" target="_blank" rel="noopener">D3</a>.</div>
        </aside>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <script>
    const QLEVER = 'https://qlever.dev/api/wikidata';
    const ACCEPT_JSON = { 'Accept': 'application/sparql-results+json' };
    const worldUrl = 'https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json';

    const fmtInt = d3.format(',d');
    const fmtMoney = d3.format('~s');

    const $loading = document.getElementById('loading');
    const $tooltip = document.getElementById('tooltip');
    const panelModeEl = document.getElementById('panelMode');
    const dataContextEl = document.getElementById('dataContext');
    const backBtn = document.getElementById('backToWorld');
    const startBtn = document.getElementById('startExploring');

    let endemicTable = null;
    let gdpTable = null;
    let populationTable = null;
    let preloadError = null;

    let worldTopo = null;
    let countries = [];
    let continents = [];
    const continentByCountryId = new Map();
    const countriesByContinent = new Map();

    const state = {
      continentName: null,
      countryId: null
    };

    let projection = null;
    let path = null;
    let rootLayer = null;
    let sphereLayer = null;
    let continentLayer = null;
    let countryLayer = null;
    let borderLayer = null;
    let zoomBehavior = null;
    let currentTransform = d3.zoomIdentity;
    let resizeTimer = null;
    let inFlight = false;

    const svg = d3.select('.map');
    const mapWrap = document.querySelector('.map-wrap');

    function setupButtons() {
      startBtn?.addEventListener('click', () => {
        document.getElementById('explorer').scrollIntoView({ behavior: 'smooth' });
      });
      backBtn?.addEventListener('click', () => { resetToContinents(); });
    }

    function resize() {
      const w = mapWrap.clientWidth || 800;
      const h = Math.max(460, window.innerHeight - 220);
      return { w, h };
    }

    async function loadGeoData() {
      worldTopo = await d3.json(worldUrl);
      countries = topojson.feature(worldTopo, worldTopo.objects.countries).features;
      assignContinents();
    }

    const NAME_OVERRIDES = new Map([
      // Europe/Asia junctions
      ['Türkiye', 'Europe'],
      ['Turkey', 'Europe'],
      ['Cyprus', 'Europe'],
      ['Georgia', 'Europe'],
      ['Kazakhstan', 'Asia'],
      ['Azerbaijan', 'Asia'],
      ['Armenia', 'Asia'],

      // Africa exceptions
      ['Egypt', 'Africa'],
      ['Madagascar', 'Africa'],
      ['Cabo Verde', 'Africa'],
      ['Seychelles', 'Africa'],
      ['Mauritius', 'Africa'],

      // Americas (Caribbean + Central)
      ['Greenland', 'North America'],
      ['Mexico', 'North America'],
      ['Guatemala', 'North America'],
      ['Belize', 'North America'],
      ['El Salvador', 'North America'],
      ['Honduras', 'North America'],
      ['Nicaragua', 'North America'],
      ['Costa Rica', 'North America'],
      ['Panama', 'North America'],
      ['Cuba', 'North America'],
      ['Jamaica', 'North America'],
      ['Haiti', 'North America'],
      ['Dominican Republic', 'North America'],
      ['Bahamas', 'North America'],
      ['The Bahamas', 'North America'],
      ['Barbados', 'North America'],
      ['Trinidad and Tobago', 'North America'],
      ['Grenada', 'North America'],
      ['Saint Lucia', 'North America'],
      ['Saint Vincent and the Grenadines', 'North America'],
      ['Dominica', 'North America'],
      ['Antigua and Barbuda', 'North America'],
      ['Saint Kitts and Nevis', 'North America'],
      ['Puerto Rico', 'North America'],

      // Middle East / Arabian Peninsula
      ['Saudi Arabia', 'Asia'],
      ['United Arab Emirates', 'Asia'],
      ['Oman', 'Asia'],
      ['Yemen', 'Asia'],
      ['Qatar', 'Asia'],
      ['Bahrain', 'Asia'],
      ['Kuwait', 'Asia'],
      ['Israel', 'Asia'],
      ['Lebanon', 'Asia'],
      ['Jordan', 'Asia'],
      ['State of Palestine', 'Asia'],

      // Oceania islands
      ['Papua New Guinea', 'Oceania'],
      ['New Caledonia', 'Oceania'],
      ['New Zealand', 'Oceania'],
      ['Fiji', 'Oceania'],
      ['Solomon Islands', 'Oceania'],
      ['Vanuatu', 'Oceania'],
      ['Samoa', 'Oceania'],
      ['Tonga', 'Oceania'],
      ['Kiribati', 'Oceania'],
      ['Micronesia', 'Oceania'],
      ['Palau', 'Oceania'],
      ['Marshall Islands', 'Oceania'],
      ['Nauru', 'Oceania'],
      ['Tuvalu', 'Oceania'],

      // South / Southeast Asia islands
      ['Timor-Leste', 'Asia'],
      ['Indonesia', 'Asia'],
      ['Philippines', 'Asia'],
      ['Japan', 'Asia'],
      ['Sri Lanka', 'Asia'],

      // Polar territories
      ['French Southern Territories', 'Antarctica']
    ]);

    function assignContinents() {
      continentByCountryId.clear();
      countriesByContinent.clear();
      const buckets = new Map();
      const geometries = worldTopo?.objects?.countries?.geometries || [];
      countries.forEach((feature, index) => {
        const continent = inferContinent(feature) || 'Unassigned';
        feature.properties = feature.properties || {};
        feature.properties.continent = continent;
        continentByCountryId.set(feature.id, continent);
        if (continent === 'Unassigned') return;
        if (!countriesByContinent.has(continent)) countriesByContinent.set(continent, []);
        countriesByContinent.get(continent).push(feature);
        if (!buckets.has(continent)) buckets.set(continent, []);
        const geom = geometries[index];
        if (geom) buckets.get(continent).push(geom);
      });

      continents = Array.from(buckets.entries())
        .filter(([name]) => name && name !== 'Unassigned')
        .map(([name, geoms]) => ({
          type: 'Feature',
          properties: { name },
          geometry: topojson.merge(worldTopo, geoms)
        }));
    }

    function inferContinent(feature) {
      const name = feature?.properties?.name;
      if (NAME_OVERRIDES.has(name)) return NAME_OVERRIDES.get(name);
      const [lon, lat] = d3.geoCentroid(feature);
      if (!Number.isFinite(lon) || !Number.isFinite(lat)) return 'Unassigned';
      if (lat <= -50) return 'Antarctica';
      if (lon < -30) {
        return lat >= 15 ? 'North America' : 'South America';
      }
      if (lon >= -25 && lon <= 60 && lat >= 35) return 'Europe';
      if (lon >= -20 && lon <= 52 && lat < 35 && lat > -40 && !(lon > 40 && lat > 20)) return 'Africa';
      if ((lon >= 110 && lat <= -10) || lon >= 150) return 'Oceania';
      if (lon >= 95 && lat <= -15) return 'Oceania';
      if (lon >= 25) return 'Asia';
      if (lat >= 0) return 'Europe';
      return 'Africa';
    }

    function initMapLayers() {
      svg.selectAll('*').remove();
      rootLayer = svg.append('g').attr('class', 'map-root');
      sphereLayer = rootLayer.append('path').attr('class', 'sphere');
      continentLayer = rootLayer.append('g').attr('class', 'continents-layer');
      countryLayer = rootLayer.append('g').attr('class', 'countries-layer');
      borderLayer = rootLayer.append('path').attr('fill', 'none').attr('stroke', '#0f1738').attr('stroke-width', 0.6);
      zoomBehavior = d3.zoom().scaleExtent([1, 8]).on('zoom', (event) => {
        currentTransform = event.transform;
        rootLayer.attr('transform', currentTransform);
      });
      svg.call(zoomBehavior);
    }

    function renderMap() {
      if (!countries.length || !continents.length) return;
      const { w, h } = resize();
      svg.attr('width', w).attr('height', h);
      projection = d3.geoMercator().fitExtent([[10, 10], [w - 10, h - 10]], { type: 'Sphere' });
      path = d3.geoPath(projection);

      sphereLayer.attr('d', path({ type: 'Sphere' }));

      continentLayer.selectAll('path')
        .data(continents, d => d.properties?.name || d.id)
        .join(
          enter => enter.append('path')
            .attr('class', 'continent')
            .attr('d', path)
            .on('mousemove', handleMouseMove)
            .on('mouseleave', handleMouseLeave)
            .on('click', (event, d) => { event.stopPropagation(); handleContinentClick(d); }),
          update => update.attr('d', path),
          exit => exit.remove()
        );

      countryLayer.selectAll('path')
        .data(countries, d => d.id)
        .join(
          enter => enter.append('path')
            .attr('class', 'country')
            .attr('d', path)
            .on('mousemove', handleMouseMove)
            .on('mouseleave', handleMouseLeave)
            .on('click', (event, d) => { event.stopPropagation(); handleCountryClick(d); }),
          update => update.attr('d', path),
          exit => exit.remove()
        );

      const mesh = topojson.mesh(worldTopo, worldTopo.objects.countries, (a, b) => a !== b);
      borderLayer.attr('d', path(mesh));

      rootLayer.attr('transform', currentTransform);
      svg.call(zoomBehavior.transform, currentTransform);
      updateContinentLayerState();
      updateCountryLayerState();
    }

    function handleMouseMove(event, feature) {
      const props = feature?.properties || {};
      const name = props.name || props.admin || props.sovereignt || props.brk_name || `ISO ${feature?.id}`;
      $tooltip.style.opacity = 1;
      $tooltip.style.left = (event.offsetX + 14) + 'px';
      $tooltip.style.top = (event.offsetY + 14) + 'px';
      $tooltip.textContent = name;
    }

    function handleMouseLeave() {
      $tooltip.style.opacity = 0;
    }

    async function handleContinentClick(feature) {
      if (!feature || inFlight) return;
      inFlight = true;
      showLoading(true);
      const contName = feature.properties?.name || 'Selected continent';
      setPanelMode('Continent overview');
      setTitle(contName);
      dataContextEl.textContent = 'Aggregating continent-wide data...';
      toggleBackButton(true);
      try {
        await ensureDataReady();
        if (preloadError) throw preloadError;
        state.continentName = contName;
        state.countryId = null;
        const summary = summarizeContinent(contName);
        updateContinentLayerState();
        updateCountryLayerState();
        zoomToFeature(feature);
        applyContinentSummary(summary, contName);
      } catch (err) {
        console.error(err);
        setAllStatuses('Request failed: unexpected error.');
        dataContextEl.textContent = 'Unable to load continent aggregates right now.';
      } finally {
        showLoading(false);
        inFlight = false;
      }
    }

    async function handleCountryClick(feature) {
      if (!feature || !state.continentName || inFlight) return;
      const contName = continentByCountryId.get(feature.id);
      if (!contName || contName !== state.continentName) return;
      inFlight = true;
      showLoading(true);
      try {
        await ensureDataReady();
        if (preloadError) throw preloadError;
        state.countryId = parseInt(feature.id, 10);
        updateCountryLayerState();
        await hydrateCountryPanel(feature);
        setPanelMode('Country profile');
        dataContextEl.textContent = 'Country-level figures pulled directly from cached Wikidata tables.';
      } catch (err) {
        console.error(err);
        setAllStatuses('Request failed: unexpected error.');
      } finally {
        showLoading(false);
        inFlight = false;
      }
    }

    function summarizeContinent(name) {
      const list = countriesByContinent.get(name) || [];
      const isoList = list.map(c => parseInt(c.id, 10)).filter(Number.isFinite);
      const summary = {
        totalCountries: list.length,
        endemicCount: 0,
        gdpCount: 0,
        popCount: 0,
        totalEndemic: 0,
        endangered: 0,
        gdpUSD: 0,
        population: 0,
        gdpYears: new Set(),
        popYears: new Set()
      };
      for (const iso of isoList) {
        const eRow = endemicTable?.get(iso);
        if (eRow) {
          summary.endemicCount++;
          summary.totalEndemic += eRow.totalEndemicSpecies || 0;
          summary.endangered += eRow.endangeredEndemicSpecies || 0;
        }
        const gRow = gdpTable?.get(iso);
        if (gRow) {
          summary.gdpCount++;
          summary.gdpUSD += gRow.gdpUSD || 0;
          if (gRow.gdpYear) summary.gdpYears.add(gRow.gdpYear);
        }
        const pRow = populationTable?.get(iso);
        if (pRow) {
          summary.popCount++;
          summary.population += pRow.population || 0;
          if (pRow.popYear) summary.popYears.add(pRow.popYear);
        }
      }
      summary.gdpYearNote = formatYearNote(summary.gdpYears);
      summary.popYearNote = formatYearNote(summary.popYears);
      summary.note = summary.totalCountries
        ? `Aggregated from ${summary.totalCountries} countries (${summary.endemicCount || 0} with endemic data).`
        : 'No linked countries found for this continent yet.';
      return summary;
    }

    function formatYearNote(set) {
      if (!set || !set.size) return '';
      const arr = Array.from(set).sort();
      if (arr.length === 1) return `Latest year: ${arr[0]}`;
      return `Latest years: ${arr[0]}–${arr[arr.length - 1]}`;
    }

    function applyContinentSummary(summary, name) {
      setTitle(name);
      if (!summary.totalCountries) {
        clearPanel();
        dataContextEl.textContent = summary.note;
        return;
      }
      if (summary.endemicCount) {
        applyEndemicResult({ status: 'ok', totalEndemicSpecies: summary.totalEndemic, endangeredEndemicSpecies: summary.endangered });
      } else {
        applyEndemicResult({ status: 'empty' });
      }
      if (summary.gdpCount) {
        applyGdpResult({ status: 'ok', gdpUSD: summary.gdpUSD, gdpYear: summary.gdpYearNote });
      } else {
        applyGdpResult({ status: 'empty' });
      }
      if (summary.popCount) {
        applyPopResult({ status: 'ok', population: summary.population, popYear: summary.popYearNote });
      } else {
        applyPopResult({ status: 'empty' });
      }
      const endemicMsg = summary.endemicCount ? `Countries with endemic data: ${summary.endemicCount}` : 'No data';
      const gdpMsg = summary.gdpCount ? `Countries with GDP data: ${summary.gdpCount}` : 'No data';
      const popMsg = summary.popCount ? `Countries with population data: ${summary.popCount}` : 'No data';
      setStatuses(endemicMsg, gdpMsg, popMsg);
      dataContextEl.textContent = `${summary.note} Select a highlighted country within ${name} to drill down.`;
      updateCountryLayerState();
      countryLayer.classed('active', true);
    }

    async function hydrateCountryPanel(feature) {
      const isoNumeric = parseInt(feature.id, 10);
      if (!Number.isFinite(isoNumeric)) return;
      const topoName = (feature.properties || {}).name || feature.properties?.admin || feature.properties?.sovereignt || feature.properties?.brk_name || '';
      const lbl = endemicTable?.get(isoNumeric)?.countryLabel
        || gdpTable?.get(isoNumeric)?.countryLabel
        || populationTable?.get(isoNumeric)?.countryLabel
        || topoName
        || `ISO numeric ${isoNumeric}`;
      setTitle(lbl);

      if (preloadError) {
        setAllStatuses('Request failed: unexpected error.');
        return;
      }

      const endemicRow = endemicTable?.get(isoNumeric);
      if (endemicRow) {
        applyEndemicResult({
          status: 'ok',
          totalEndemicSpecies: endemicRow.totalEndemicSpecies,
          endangeredEndemicSpecies: endemicRow.endangeredEndemicSpecies
        });
      } else {
        applyEndemicResult({ status: 'empty' });
      }

      const gRow = gdpTable?.get(isoNumeric);
      if (gRow) {
        applyGdpResult({ status: 'ok', gdpUSD: gRow.gdpUSD, gdpYear: gRow.gdpYear });
      } else {
        applyGdpResult({ status: 'empty' });
      }

      const pRow = populationTable?.get(isoNumeric);
      if (pRow) {
        applyPopResult({ status: 'ok', population: pRow.population, popYear: pRow.popYear });
      } else {
        applyPopResult({ status: 'empty' });
      }

      setStatuses('', '', '');
    }

    function updateContinentLayerState() {
      if (!continentLayer) return;
      continentLayer.selectAll('path')
        .classed('continent-selected', d => state.continentName && (d.properties?.name === state.continentName))
        .classed('continent-dim', d => state.continentName && (d.properties?.name !== state.continentName));
    }

    function updateCountryLayerState() {
      if (!countryLayer) return;
      const active = Boolean(state.continentName);
      countryLayer.classed('active', active);
      countryLayer.selectAll('path')
        .classed('country-muted', d => active && continentByCountryId.get(d.id) !== state.continentName)
        .classed('country-selected', d => state.countryId === parseInt(d.id, 10));
    }

    function zoomToFeature(feature) {
      if (!feature || !path) return;
      const [[x0, y0], [x1, y1]] = path.bounds(feature);
      const w = parseFloat(svg.attr('width')) || 800;
      const h = parseFloat(svg.attr('height')) || 500;
      const dx = x1 - x0;
      const dy = y1 - y0;
      const x = (x0 + x1) / 2;
      const y = (y0 + y1) / 2;
      const scale = Math.min(8, 0.85 / Math.max(dx / w, dy / h));
      const translate = [w / 2 - scale * x, h / 2 - scale * y];
      svg.transition().duration(850).call(
        zoomBehavior.transform,
        d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
      );
    }

    function resetZoom() {
      svg.transition().duration(650).call(zoomBehavior.transform, d3.zoomIdentity);
    }

    function resetToContinents() {
      state.continentName = null;
      state.countryId = null;
      setPanelMode('Continent overview');
      setTitle('Select a continent');
      dataContextEl.textContent = 'Select a continent to see aggregated totals.';
      clearPanel();
      updateContinentLayerState();
      updateCountryLayerState();
      toggleBackButton(false);
      countryLayer?.classed('active', false);
      resetZoom();
    }

    function toggleBackButton(active) {
      if (backBtn) backBtn.disabled = !active;
    }

    function onResize() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        renderMap();
      }, 150);
    }

    async function ensureDataReady() {
      if (endemicTable && gdpTable && populationTable) return;
      try {
        await preloadAllTables();
      } catch (err) {
        preloadError = err;
        throw err;
      }
    }

    async function preloadAllTables() {
      const endData = await runSparqlGETWithRetry(Q_END_EMD);
      endemicTable = buildEndemicMap(endData);

      const gdpData = await runSparqlGETWithRetry(Q_GDP);
      gdpTable = buildGdpMap(gdpData);

      const popData = await runSparqlGETWithRetry(Q_POP);
      populationTable = buildPopulationMap(popData);
    }

    async function runSparqlGETWithRetry(query, { retries = 3, baseDelayMs = 400 } = {}) {
      let attempt = 0;
      while (true) {
        try {
          const url = QLEVER + '?query=' + encodeURIComponent(query);
          const res = await fetch(url, { method: 'GET', headers: ACCEPT_JSON });
          if (!res.ok) {
            if ((res.status === 429 || res.status === 403 || res.status === 503) && attempt < retries) {
              attempt++;
              await delayWithJitter(baseDelayMs, attempt);
              continue;
            }
            throw new Error(`QLever error ${res.status}`);
          }
          return await res.json();
        } catch (e) {
          if (attempt < retries) {
            attempt++;
            await delayWithJitter(baseDelayMs, attempt);
            continue;
          }
          throw e;
        }
      }
    }

    function delayWithJitter(base, attempt) {
      const jitter = Math.random() * 400;
      const wait = Math.min(800, base * attempt) + jitter;
      return new Promise(r => setTimeout(r, wait));
    }

    const Q_END_EMD = `
PREFIX wd:   <http://www.wikidata.org/entity/>
PREFIX wdt:  <http://www.wikidata.org/prop/direct/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT
  ?country
  ?countryLabel
  ?iso3
  ?isoNum
  (COALESCE(?allSpecies, 0)        AS ?totalEndemicSpecies)
  (COALESCE(?endangeredSpecies, 0) AS ?endangeredEndemicSpecies)
WHERE {
  ?country wdt:P31 wd:Q6256 .
  OPTIONAL { ?country rdfs:label ?countryLabel . FILTER(LANG(?countryLabel) = "en") }
  OPTIONAL { ?country wdt:P298 ?iso3 }
  OPTIONAL { ?country wdt:P299 ?isoNum }

  OPTIONAL {
    SELECT ?country (COUNT(DISTINCT ?sp) AS ?allSpecies)
    WHERE {
      ?sp wdt:P31 wd:Q16521 ;
          wdt:P105 wd:Q7432 ;
          wdt:P183 ?country .
      ?country wdt:P31 wd:Q6256 .
    }
    GROUP BY ?country
  }

  OPTIONAL {
    SELECT ?country (COUNT(DISTINCT ?sp2) AS ?endangeredSpecies)
    WHERE {
      ?sp2 wdt:P31  wd:Q16521 ;
           wdt:P105 wd:Q7432 ;
           wdt:P141 wd:Q96377276 ;
           wdt:P183 ?country .
      ?country wdt:P31 wd:Q6256 .
    }
    GROUP BY ?country
  }
}
ORDER BY DESC(?totalEndemicSpecies)
`;

    const Q_GDP = `
PREFIX wd:   <http://www.wikidata.org/entity/>
PREFIX wdt:  <http://www.wikidata.org/prop/direct/>
PREFIX p:    <http://www.wikidata.org/prop/>
PREFIX ps:   <http://www.wikidata.org/prop/statement/>
PREFIX pq:   <http://www.wikidata.org/prop/qualifier/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT
  ?country
  ?countryLabel
  ?iso3
  ?isoNum
  ?gdpUSD
  ?gdpYear
WHERE {
  ?country wdt:P31 wd:Q6256 .
  OPTIONAL { ?country rdfs:label ?countryLabel . FILTER(LANG(?countryLabel) = "en") }
  OPTIONAL { ?country wdt:P298 ?iso3 }
  OPTIONAL { ?country wdt:P299 ?isoNum }

  {
    SELECT ?country (MAX(?date) AS ?latestDate)
    WHERE {
      ?country wdt:P31 wd:Q6256 ;
               p:P2131 ?st .
      ?st pq:P585 ?date .
    }
    GROUP BY ?country
  }

  ?country p:P2131 ?st2 .
  ?st2 pq:P585 ?latestDate ;
       ps:P2131 ?gdpUSD .
  BIND(YEAR(?latestDate) AS ?gdpYear)
}
ORDER BY DESC(?gdpUSD)
`;

    const Q_POP = `
PREFIX wd:   <http://www.wikidata.org/entity/>
PREFIX wdt:  <http://www.wikidata.org/prop/direct/>
PREFIX p:    <http://www.wikidata.org/prop/>
PREFIX ps:   <http://www.wikidata.org/prop/statement/>
PREFIX pq:   <http://www.wikidata.org/prop/qualifier/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT
  ?country
  ?countryLabel
  ?iso3
  ?isoNum
  ?population
  ?popYear
WHERE {
  ?country wdt:P31 wd:Q6256 .
  OPTIONAL { ?country rdfs:label ?countryLabel . FILTER(LANG(?countryLabel) = "en") }
  OPTIONAL { ?country wdt:P298 ?iso3 }
  OPTIONAL { ?country wdt:P299 ?isoNum }

  {
    SELECT ?country (MAX(?date) AS ?latestDate)
    WHERE {
      ?country wdt:P31 wd:Q6256 ;
               p:P1082 ?popStmt .
      ?popStmt pq:P585 ?date .
    }
    GROUP BY ?country
  }

  ?country p:P1082 ?popStmt2 .
  ?popStmt2 pq:P585 ?latestDate ;
            ps:P1082 ?population .
  BIND(YEAR(?latestDate) AS ?popYear)
}
ORDER BY DESC(?population)
`;

    function buildEndemicMap(json) {
      const m = new Map();
      const rows = json?.results?.bindings || [];
      for (const r of rows) {
        const isoNumStr = r.isoNum?.value;
        const isoInt = isoNumStr ? parseInt(isoNumStr, 10) : NaN;
        if (!Number.isFinite(isoInt)) continue;
        m.set(isoInt, {
          countryLabel: r.countryLabel?.value || '',
          iso3: r.iso3?.value || '',
          isoNum: isoNumStr,
          totalEndemicSpecies: +(r.totalEndemicSpecies?.value || 0),
          endangeredEndemicSpecies: +(r.endangeredEndemicSpecies?.value || 0)
        });
      }
      return m;
    }

    function buildGdpMap(json) {
      const m = new Map();
      const rows = json?.results?.bindings || [];
      for (const r of rows) {
        const isoNumStr = r.isoNum?.value;
        const isoInt = isoNumStr ? parseInt(isoNumStr, 10) : NaN;
        if (!Number.isFinite(isoInt)) continue;
        m.set(isoInt, {
          countryLabel: r.countryLabel?.value || '',
          iso3: r.iso3?.value || '',
          isoNum: isoNumStr,
          gdpUSD: +(r.gdpUSD?.value || 0),
          gdpYear: r.gdpYear?.value || ''
        });
      }
      return m;
    }

    function buildPopulationMap(json) {
      const m = new Map();
      const rows = json?.results?.bindings || [];
      for (const r of rows) {
        const isoNumStr = r.isoNum?.value;
        const isoInt = isoNumStr ? parseInt(isoNumStr, 10) : NaN;
        if (!Number.isFinite(isoInt)) continue;
        m.set(isoInt, {
          countryLabel: r.countryLabel?.value || '',
          iso3: r.iso3?.value || '',
          isoNum: isoNumStr,
          population: +(r.population?.value || 0),
          popYear: r.popYear?.value || ''
        });
      }
      return m;
    }

    function showLoading(on) {
      $loading.style.display = on ? 'flex' : 'none';
      $loading.setAttribute('aria-hidden', on ? 'false' : 'true');
    }

    function setPanelMode(text) {
      panelModeEl.textContent = text;
    }

    function setTitle(text) {
      document.getElementById('country-title').textContent = text || 'Select a continent';
    }

    function clearPanel() {
      setEndemic({ status: null });
      setGDP({ status: null });
      setPopulation({ status: null });
      drawEndemicChart(0, 0);
      setStatuses('', '', '');
    }

    function setStatuses(endemicMsg, gdpMsg, popMsg) {
      const es = document.getElementById('endemicStatus');
      const gs = document.getElementById('gdpStatus');
      const ps = document.getElementById('popStatus');
      es.textContent = endemicMsg || '';
      gs.textContent = gdpMsg || '';
      ps.textContent = popMsg || '';
      [es, gs, ps].forEach(el => el.classList.remove('err'));
    }

    function setAllStatuses(message) {
      const es = document.getElementById('endemicStatus');
      const gs = document.getElementById('gdpStatus');
      const ps = document.getElementById('popStatus');
      [es, gs, ps].forEach(el => { el.textContent = message || ''; el.classList.add('err'); });
    }

    function applyEndemicResult(res) {
      const status = document.getElementById('endemicStatus');
      if (res.status === 'ok') {
        setEndemic(res);
        drawEndemicChart(res.totalEndemicSpecies, res.endangeredEndemicSpecies);
        status.textContent = '';
        status.classList.remove('err');
      } else if (res.status === 'empty') {
        setEndemic({ status: 'empty' });
        drawEndemicChart(0, 0);
        status.textContent = 'No data';
        status.classList.remove('err');
      } else if (res.status === 'error') {
        setEndemic({ status: 'error' });
        drawEndemicChart(0, 0);
        status.textContent = 'Request failed';
        status.classList.add('err');
      } else {
        setEndemic({ status: null });
        drawEndemicChart(0, 0);
        status.textContent = '';
        status.classList.remove('err');
      }
    }

    function applyGdpResult(res) {
      const status = document.getElementById('gdpStatus');
      if (res.status === 'ok') {
        setGDP(res);
        status.textContent = '';
        status.classList.remove('err');
      } else if (res.status === 'empty') {
        setGDP({ status: 'empty' });
        status.textContent = 'No data';
        status.classList.remove('err');
      } else if (res.status === 'error') {
        setGDP({ status: 'error' });
        status.textContent = 'Request failed';
        status.classList.add('err');
      } else {
        setGDP({ status: null });
        status.textContent = '';
        status.classList.remove('err');
      }
    }

    function applyPopResult(res) {
      const status = document.getElementById('popStatus');
      if (res.status === 'ok') {
        setPopulation(res);
        status.textContent = '';
        status.classList.remove('err');
      } else if (res.status === 'empty') {
        setPopulation({ status: 'empty' });
        status.textContent = 'No data';
        status.classList.remove('err');
      } else if (res.status === 'error') {
        setPopulation({ status: 'error' });
        status.textContent = 'Request failed';
        status.classList.add('err');
      } else {
        setPopulation({ status: null });
        status.textContent = '';
        status.classList.remove('err');
      }
    }

    function setEndemic(payload) {
      const totalEl = document.getElementById('totalEndemic');
      const endEl = document.getElementById('endangeredEndemic');
      if (payload.status === 'ok') {
        totalEl.textContent = fmtInt(payload.totalEndemicSpecies);
        endEl.textContent = fmtInt(payload.endangeredEndemicSpecies);
      } else if (payload.status === 'empty') {
        totalEl.textContent = '—';
        endEl.textContent = '—';
      } else if (payload.status === 'error') {
        totalEl.textContent = 'Request failed';
        endEl.textContent = 'Request failed';
      } else {
        totalEl.textContent = '—';
        endEl.textContent = '—';
      }
    }

    function setGDP(payload) {
      const g = document.getElementById('gdp');
      const gy = document.getElementById('gdpYear');
      if (payload.status === 'ok') {
        g.textContent = `${fmtMoney(payload.gdpUSD)} USD`;
        gy.textContent = formatYearLabel(payload.gdpYear);
      } else if (payload.status === 'empty') {
        g.textContent = '—';
        gy.textContent = '';
      } else if (payload.status === 'error') {
        g.textContent = 'Request failed';
        gy.textContent = '';
      } else {
        g.textContent = '—';
        gy.textContent = '';
      }
    }

    function setPopulation(payload) {
      const p = document.getElementById('population');
      const py = document.getElementById('popYear');
      if (payload.status === 'ok') {
        p.textContent = fmtInt(payload.population);
        py.textContent = formatYearLabel(payload.popYear);
      } else if (payload.status === 'empty') {
        p.textContent = '—';
        py.textContent = '';
      } else if (payload.status === 'error') {
        p.textContent = 'Request failed';
        py.textContent = '';
      } else {
        p.textContent = '—';
        py.textContent = '';
      }
    }

    function drawEndemicChart(total, endangered) {
      const cont = d3.select('#chart');
      cont.selectAll('*').remove();
      const W = 300, H = 160, M = { t: 10, r: 12, b: 26, l: 42 };
      const data = [
        { k: 'Endemic', v: +total || 0 },
        { k: 'Endangered endemic', v: +endangered || 0 }
      ];
      const svgC = cont.append('svg').attr('width', W).attr('height', H);
      const x = d3.scaleBand().domain(data.map(d => d.k)).range([M.l, W - M.r]).padding(0.35);
      const y = d3.scaleLinear().domain([0, d3.max(data, d => d.v) || 1]).nice().range([H - M.b, M.t]);

      svgC.append('g')
        .selectAll('rect')
        .data(data)
        .join('rect')
        .attr('x', d => x(d.k))
        .attr('y', d => y(d.v))
        .attr('width', x.bandwidth())
        .attr('height', d => y(0) - y(d.v))
        .attr('fill', (d, i) => i === 0 ? '#6fb1ff' : '#9ad98b');

      const ax = d3.axisBottom(x);
      const ay = d3.axisLeft(y).ticks(5).tickFormat(d3.format('.2s'));

      svgC.append('g').attr('transform', `translate(0,${H - M.b})`).call(ax)
        .selectAll('text').style('fill', '#a8b3c7').style('font-size', '11px');
      svgC.append('g').attr('transform', `translate(${M.l},0)`).call(ay)
        .call(g => g.selectAll('text').style('fill', '#a8b3c7').style('font-size', '11px'))
        .call(g => g.selectAll('line,path').attr('stroke', '#2a3666'));
    }

    function formatYearLabel(value) {
      if (!value) return '';
      if (typeof value === 'string' && (value.startsWith('Latest') || value.includes(':'))) {
        return value;
      }
      return `Year: ${value}`;
    }

    function handleInitError(err) {
      console.error(err);
      dataContextEl.textContent = 'Unable to draw the basemap right now. Please retry.';
    }

    async function boot() {
      setupButtons();
      try {
        await loadGeoData();
        initMapLayers();
        renderMap();
        window.addEventListener('resize', onResize, { passive: true });
        clearPanel();
      } catch (err) {
        handleInitError(err);
      }
    }

    boot();
  </script>
</body>
</html>
