<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Highlighting the correlation between endangered species and the economic growth of countries</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1020; --ink:#f2f4f8; --accent:#6fb1ff; --muted:#a8b3c7; --panel:#121831; }
    html,body { margin:0; height:100%; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; }
    header { padding:18px 24px; border-bottom:1px solid #1e2748; }
    h1 { margin:0; font-size:18px; line-height:1.3; }
    .app { display:grid; grid-template-columns: 1.2fr 0.8fr; gap:0; min-height:calc(100% - 64px); }
    .map-wrap { position:relative; }
    .map { width:100%; height:100%; }
    .sidebar { background:var(--panel); border-left:1px solid #1e2748; padding:18px; overflow:auto; }
    .sidebar h2 { font-size:16px; margin:0 0 8px; }
    .sidebar .small { color:var(--muted); font-size:12px; }
    .metric { margin:14px 0; }
    .metric-label { color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.04em; }
    .metric-value { font-size:20px; margin-top:4px; }
    .loading { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; background:transparent; }
    .spinner { width:42px; height:42px; border:4px solid #33406a; border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; }
    .tooltip { position:absolute; pointer-events:none; background:#0e1530; color:var(--ink); padding:6px 8px; border:1px solid #1f2a50; border-radius:6px; font-size:12px; box-shadow:0 6px 20px rgba(0,0,0,.25); opacity:0; transition:opacity .15s; }
    .note { margin-top:10px; color:var(--muted); font-size:12px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .legend { margin:10px 0 2px; font-size:12px; color:var(--muted); }
    .attribution { margin-top:14px; font-size:11px; color:var(--muted); }
    a, a:visited { color:var(--accent); text-decoration:none; }
    a:hover { text-decoration:underline; }
    .status { font-size:12px; color:var(--muted); margin-top:4px; }
    .err { color:#ff9aa2; }
  </style>
</head>
<body>
  <header>
    <h1>Highlighting the correlation between endangered species and the economic growth of countries</h1>
  </header>

  <div class="app">
    <div class="map-wrap">
      <svg class="map"></svg>
      <div class="loading" id="loading" aria-hidden="true" style="display:none;"><div class="spinner"></div></div>
      <div class="tooltip" id="tooltip"></div>
    </div>
    <aside class="sidebar">
      <h2 id="country-title">Click a country</h2>
      <div class="small">The panel will show:
        <ul>
          <li>Total endemic species</li>
          <li>Endangered endemic species</li>
          <li>Latest nominal GDP (USD)</li>
          <li>Latest population</li>
        </ul>
      </div>

      <div class="metric">
        <div class="metric-label">Total endemic species</div>
        <div class="metric-value" id="totalEndemic">—</div>
        <div class="status" id="endemicStatus"></div>
      </div>
      <div class="metric">
        <div class="metric-label">Endangered endemic species</div>
        <div class="metric-value" id="endangeredEndemic">—</div>
      </div>

      <div id="chart" style="margin:10px 0 6px;"></div>
      <div class="legend">Bar chart: endemic vs. endangered endemic</div>

      <div class="metric" style="margin-top:18px;">
        <div class="metric-label">Latest nominal GDP (USD)</div>
        <div class="metric-value" id="gdp">—</div>
        <div class="small" id="gdpYear"></div>
        <div class="status" id="gdpStatus"></div>
      </div>

      <div class="metric">
        <div class="metric-label">Latest population</div>
        <div class="metric-value" id="population">—</div>
        <div class="small" id="popYear"></div>
        <div class="status" id="popStatus"></div>
      </div>

      <div class="note">Data source: QLever Wikidata (live). Served once, filtered client-side per click.</div>
      <div class="attribution">Map © <a href="https://github.com/topojson/world-atlas" target="_blank" rel="noopener">world-atlas</a> · Built with <a href="https://d3js.org/" target="_blank" rel="noopener">D3</a>.</div>
    </aside>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <script>
    // QLever endpoint (GET ?query=...)
    const QLEVER = 'https://qlever.dev/api/wikidata';
    const ACCEPT_JSON = { 'Accept': 'application/sparql-results+json' };
    const worldUrl = 'https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json';

    const fmtInt = d3.format(',d');
    const fmtMoney = d3.format('~s');

    const $loading = document.getElementById('loading');
    const $tooltip = document.getElementById('tooltip');

    // Global caches: whole tables keyed by ISO numeric (int)
    let endemicTable = null;     // Map<int, {countryLabel, iso3, isoNum(str), totalEndemicSpecies, endangeredEndemicSpecies}>
    let gdpTable = null;         // Map<int, {gdpUSD, gdpYear, countryLabel, ...}>
    let populationTable = null;  // Map<int, {population, popYear, countryLabel, ...}>
    let preloadError = null;

    // Map init
    const svg = d3.select('.map');
    const mapWrap = document.querySelector('.map-wrap');

    function resize() {
      const w = mapWrap.clientWidth;
      const h = Math.max(420, window.innerHeight - 80);
      svg.attr('width', w).attr('height', h);
      return { w, h };
    }

    async function drawMap() {
      const { w, h } = resize();
      const world = await d3.json(worldUrl);
      const countries = topojson.feature(world, world.objects.countries).features;

      const projection = d3.geoMercator().fitExtent([[10, 10], [w-10, h-10]], { type:'Sphere' });
      const path = d3.geoPath().projection(projection);

      svg.append('path')
        .attr('d', path({ type: 'Sphere' }))
        .attr('fill', '#0a1029')
        .attr('stroke', '#1b2551')
        .attr('stroke-width', 1);

      svg.append('g')
        .attr('fill', '#162145')
        .attr('stroke', '#223064')
        .attr('stroke-width', 0.7)
        .selectAll('path')
        .data(countries)
        .join('path')
        .attr('d', path)
        .on('mousemove', (event, d) => {
          const p = d.properties || {};
          const name = p.name || p.admin || p.sovereignt || p.brk_name || null;
          $tooltip.style.opacity = 1;
          $tooltip.style.left = (event.offsetX + 14) + 'px';
          $tooltip.style.top = (event.offsetY + 14) + 'px';
          $tooltip.textContent = name ? `${name}` : `ISO numeric: ${d.id}`;
        })
        .on('mouseleave', () => { $tooltip.style.opacity = 0; })
        .on('click', (event, d) => handleCountryClick(d));

      svg.append('path')
        .attr('fill', 'none')
        .attr('stroke', '#0f1738')
        .attr('stroke-width', 0.6)
        .attr('d', path(topojson.mesh(world, world.objects.countries, (a, b) => a !== b)));

      window.addEventListener('resize', () => {
        svg.selectAll('*').remove();
        drawMap();
      }, { passive:true, once:true });
    }

    // ---------- QLever GET runner + retry/backoff ----------
    async function runSparqlGETWithRetry(query, { retries = 3, baseDelayMs = 400 } = {}) {
      let attempt = 0;
      while (true) {
        try {
          const url = QLEVER + '?query=' + encodeURIComponent(query);
          const res = await fetch(url, { method: 'GET', headers: ACCEPT_JSON });
          if (!res.ok) {
            if ((res.status === 429 || res.status === 403 || res.status === 503) && attempt < retries) {
              attempt++;
              await delayWithJitter(baseDelayMs, attempt);
              continue;
            }
            throw new Error(`QLever error ${res.status}`);
          }
          return await res.json();
        } catch (e) {
          if (attempt < retries) {
            attempt++;
            await delayWithJitter(baseDelayMs, attempt);
            continue;
          }
          throw e;
        }
      }
    }

    function delayWithJitter(base, attempt) {
      const jitter = Math.random() * 400;
      const wait = Math.min(800, base * attempt) + jitter;
      return new Promise(r => setTimeout(r, wait));
    }

    // ---------- EXACT QUERIES (as you provided) ----------
    const Q_END_EMD = `
PREFIX wd:   <http://www.wikidata.org/entity/>
PREFIX wdt:  <http://www.wikidata.org/prop/direct/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT
  ?country
  ?countryLabel
  ?iso3
  ?isoNum
  (COALESCE(?allSpecies, 0)        AS ?totalEndemicSpecies)
  (COALESCE(?endangeredSpecies, 0) AS ?endangeredEndemicSpecies)
WHERE {
  ?country wdt:P31 wd:Q6256 .                # country
  OPTIONAL { ?country rdfs:label ?countryLabel . FILTER(LANG(?countryLabel) = "en") }
  OPTIONAL { ?country wdt:P298 ?iso3 }       # ISO 3166-1 alpha-3
  OPTIONAL { ?country wdt:P299 ?isoNum }     # ISO 3166-1 numeric (string in WD)

  # Total endemic species (rank = species)
  OPTIONAL {
    SELECT ?country (COUNT(DISTINCT ?sp) AS ?allSpecies)
    WHERE {
      ?sp wdt:P31 wd:Q16521 ;               # taxon
          wdt:P105 wd:Q7432 ;               # rank = species
          wdt:P183 ?country .               # endemic to (country)
      ?country wdt:P31 wd:Q6256 .
    }
    GROUP BY ?country
  }

  # Endangered endemic species (IUCN Endangered)
  OPTIONAL {
    SELECT ?country (COUNT(DISTINCT ?sp2) AS ?endangeredSpecies)
    WHERE {
      ?sp2 wdt:P31  wd:Q16521 ;
           wdt:P105 wd:Q7432 ;
           wdt:P141 wd:Q96377276 ;          # conservation status = Endangered
           wdt:P183 ?country .
      ?country wdt:P31 wd:Q6256 .
    }
    GROUP BY ?country
  }
}
ORDER BY DESC(?totalEndemicSpecies)
`;

    const Q_GDP = `
PREFIX wd:   <http://www.wikidata.org/entity/>
PREFIX wdt:  <http://www.wikidata.org/prop/direct/>
PREFIX p:    <http://www.wikidata.org/prop/>
PREFIX ps:   <http://www.wikidata.org/prop/statement/>
PREFIX pq:   <http://www.wikidata.org/prop/qualifier/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT
  ?country
  ?countryLabel
  ?iso3
  ?isoNum
  ?gdpUSD
  ?gdpYear
WHERE {
  ?country wdt:P31 wd:Q6256 .
  OPTIONAL { ?country rdfs:label ?countryLabel . FILTER(LANG(?countryLabel) = "en") }
  OPTIONAL { ?country wdt:P298 ?iso3 }
  OPTIONAL { ?country wdt:P299 ?isoNum }

  # Find latest GDP date per country
  {
    SELECT ?country (MAX(?date) AS ?latestDate)
    WHERE {
      ?country wdt:P31 wd:Q6256 ;
               p:P2131 ?st .                # nominal GDP
      ?st pq:P585 ?date .                   # point in time
    }
    GROUP BY ?country
  }

  # Pull GDP value for that latest date
  ?country p:P2131 ?st2 .
  ?st2 pq:P585 ?latestDate ;
       ps:P2131 ?gdpUSD .
  BIND(YEAR(?latestDate) AS ?gdpYear)
}
ORDER BY DESC(?gdpUSD)
`;

    const Q_POP = `
PREFIX wd:   <http://www.wikidata.org/entity/>
PREFIX wdt:  <http://www.wikidata.org/prop/direct/>
PREFIX p:    <http://www.wikidata.org/prop/>
PREFIX ps:   <http://www.wikidata.org/prop/statement/>
PREFIX pq:   <http://www.wikidata.org/prop/qualifier/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT
  ?country
  ?countryLabel
  ?iso3
  ?isoNum
  ?population
  ?popYear
WHERE {
  ?country wdt:P31 wd:Q6256 .
  OPTIONAL { ?country rdfs:label ?countryLabel . FILTER(LANG(?countryLabel) = "en") }
  OPTIONAL { ?country wdt:P298 ?iso3 }
  OPTIONAL { ?country wdt:P299 ?isoNum }

  # Find latest population date per country
  {
    SELECT ?country (MAX(?date) AS ?latestDate)
    WHERE {
      ?country wdt:P31 wd:Q6256 ;
               p:P1082 ?popStmt .           # population
      ?popStmt pq:P585 ?date .              # point in time
    }
    GROUP BY ?country
  }

  # Pull population value for that latest date
  ?country p:P1082 ?popStmt2 .
  ?popStmt2 pq:P585 ?latestDate ;
            ps:P1082 ?population .
  BIND(YEAR(?latestDate) AS ?popYear)
}
ORDER BY DESC(?population)
`;

    // ---------- Preload: run the 3 queries once, build fast lookup maps ----------
    async function preloadAllTables() {
      // sequential + retry/backoff
      const endData = await runSparqlGETWithRetry(Q_END_EMD);
      endemicTable = buildEndemicMap(endData);

      const gdpData = await runSparqlGETWithRetry(Q_GDP);
      gdpTable = buildGdpMap(gdpData);

      const popData = await runSparqlGETWithRetry(Q_POP);
      populationTable = buildPopulationMap(popData);
    }

    function buildEndemicMap(json) {
      const m = new Map();
      const rows = json?.results?.bindings || [];
      for (const r of rows) {
        const isoNumStr = r.isoNum?.value;
        const isoInt = isoNumStr ? parseInt(isoNumStr, 10) : NaN;
        if (!Number.isFinite(isoInt)) continue;
        m.set(isoInt, {
          countryLabel: r.countryLabel?.value || '',
          iso3: r.iso3?.value || '',
          isoNum: isoNumStr,
          totalEndemicSpecies: +(r.totalEndemicSpecies?.value || 0),
          endangeredEndemicSpecies: +(r.endangeredEndemicSpecies?.value || 0)
        });
      }
      return m;
    }

    function buildGdpMap(json) {
      const m = new Map();
      const rows = json?.results?.bindings || [];
      for (const r of rows) {
        const isoNumStr = r.isoNum?.value;
        const isoInt = isoNumStr ? parseInt(isoNumStr, 10) : NaN;
        if (!Number.isFinite(isoInt)) continue;
        m.set(isoInt, {
          countryLabel: r.countryLabel?.value || '',
          iso3: r.iso3?.value || '',
          isoNum: isoNumStr,
          gdpUSD: +(r.gdpUSD?.value || 0),
          gdpYear: r.gdpYear?.value || ''
        });
      }
      return m;
    }

    function buildPopulationMap(json) {
      const m = new Map();
      const rows = json?.results?.bindings || [];
      for (const r of rows) {
        const isoNumStr = r.isoNum?.value;
        const isoInt = isoNumStr ? parseInt(isoNumStr, 10) : NaN;
        if (!Number.isFinite(isoInt)) continue;
        m.set(isoInt, {
          countryLabel: r.countryLabel?.value || '',
          iso3: r.iso3?.value || '',
          isoNum: isoNumStr,
          population: +(r.population?.value || 0),
          popYear: r.popYear?.value || ''
        });
      }
      return m;
    }

    // ---------- Click handling ----------
    let inFlight = false;

    async function handleCountryClick(feature) {
      if (inFlight) return;
      inFlight = true;

      const isoNumeric = parseInt(feature.id, 10);
      showLoading(true);
      clearPanel();

      try {
        // Ensure preload happened
        if (!endemicTable || !gdpTable || !populationTable) {
          try {
            await preloadAllTables();
          } catch (e) {
            console.error(e);
            preloadError = e;
          }
        }

        // Title: prefer label from any table, else fallback to topo name
        const topoName = (feature.properties||{}).name || feature.properties?.admin || feature.properties?.sovereignt || feature.properties?.brk_name || '';
        const lbl = endemicTable?.get(isoNumeric)?.countryLabel
                 || gdpTable?.get(isoNumeric)?.countryLabel
                 || populationTable?.get(isoNumeric)?.countryLabel
                 || topoName
                 || `ISO numeric ${isoNumeric}`;
        setTitle(lbl);

        // Endemic
        if (preloadError) {
          applyEndemicResult({ status: 'error' });
        } else {
          const row = endemicTable?.get(isoNumeric);
          if (row) {
            applyEndemicResult({
              status: 'ok',
              totalEndemicSpecies: row.totalEndemicSpecies,
              endangeredEndemicSpecies: row.endangeredEndemicSpecies
            });
          } else {
            applyEndemicResult({ status: 'empty' });
          }
        }

        // GDP
        if (preloadError) {
          applyGdpResult({ status: 'error' });
        } else {
          const row = gdpTable?.get(isoNumeric);
          if (row) {
            applyGdpResult({
              status: 'ok',
              gdpUSD: row.gdpUSD,
              gdpYear: row.gdpYear
            });
          } else {
            applyGdpResult({ status: 'empty' });
          }
        }

        // Population
        if (preloadError) {
          applyPopResult({ status: 'error' });
        } else {
          const row = populationTable?.get(isoNumeric);
          if (row) {
            applyPopResult({
              status: 'ok',
              population: row.population,
              popYear: row.popYear
            });
          } else {
            applyPopResult({ status: 'empty' });
          }
        }

      } catch (err) {
        console.error(err);
        setAllStatuses('Request failed: unexpected error.');
      } finally {
        showLoading(false);
        inFlight = false;
      }
    }

    // ---------- UI helpers ----------
    function showLoading(on) {
      $loading.style.display = on ? 'flex' : 'none';
      $loading.setAttribute('aria-hidden', on ? 'false' : 'true');
    }

    function setTitle(text) {
      document.getElementById('country-title').textContent = text || 'Click a country';
    }

    function clearPanel() {
      setEndemic({ status:null });
      setGDP({ status:null });
      setPopulation({ status:null });
      drawEndemicChart(0, 0);
      setStatuses('', '', '');
    }

    function setStatuses(endemicMsg, gdpMsg, popMsg) {
      const es = document.getElementById('endemicStatus');
      const gs = document.getElementById('gdpStatus');
      const ps = document.getElementById('popStatus');
      es.textContent = endemicMsg || '';
      gs.textContent = gdpMsg || '';
      ps.textContent = popMsg || '';
      [es, gs, ps].forEach(el => el.classList.remove('err'));
    }

    function setAllStatuses(message) {
      const es = document.getElementById('endemicStatus');
      const gs = document.getElementById('gdpStatus');
      const ps = document.getElementById('popStatus');
      [es, gs, ps].forEach(el => { el.textContent = message || ''; el.classList.add('err'); });
    }

    function applyEndemicResult(res) {
      if (res.status === 'ok') {
        setEndemic(res);
        drawEndemicChart(res.totalEndemicSpecies, res.endangeredEndemicSpecies);
        document.getElementById('endemicStatus').textContent = '';
        document.getElementById('endemicStatus').classList.remove('err');
      } else if (res.status === 'empty') {
        setEndemic({ status:'empty' });
        document.getElementById('endemicStatus').textContent = 'No data';
        document.getElementById('endemicStatus').classList.remove('err');
        drawEndemicChart(0, 0);
      } else {
        setEndemic({ status:'error' });
        document.getElementById('endemicStatus').textContent = 'Request failed';
        document.getElementById('endemicStatus').classList.add('err');
        drawEndemicChart(0, 0);
      }
    }

    function applyGdpResult(res) {
      if (res.status === 'ok') {
        setGDP(res);
        document.getElementById('gdpStatus').textContent = '';
        document.getElementById('gdpStatus').classList.remove('err');
      } else if (res.status === 'empty') {
        setGDP({ status:'empty' });
        document.getElementById('gdpStatus').textContent = 'No data';
        document.getElementById('gdpStatus').classList.remove('err');
      } else {
        setGDP({ status:'error' });
        document.getElementById('gdpStatus').textContent = 'Request failed';
        document.getElementById('gdpStatus').classList.add('err');
      }
    }

    function applyPopResult(res) {
      if (res.status === 'ok') {
        setPopulation(res);
        document.getElementById('popStatus').textContent = '';
        document.getElementById('popStatus').classList.remove('err');
      } else if (res.status === 'empty') {
        setPopulation({ status:'empty' });
        document.getElementById('popStatus').textContent = 'No data';
        document.getElementById('popStatus').classList.remove('err');
      } else {
        setPopulation({ status:'error' });
        document.getElementById('popStatus').textContent = 'Request failed';
        document.getElementById('popStatus').classList.add('err');
      }
    }

    function setEndemic(payload) {
      const totalEl = document.getElementById('totalEndemic');
      const endEl = document.getElementById('endangeredEndemic');
      if (payload.status === 'ok') {
        totalEl.textContent = fmtInt(payload.totalEndemicSpecies);
        endEl.textContent = fmtInt(payload.endangeredEndemicSpecies);
      } else if (payload.status === 'empty') {
        totalEl.textContent = '—';
        endEl.textContent = '—';
      } else if (payload.status === 'error') {
        totalEl.textContent = 'Request failed';
        endEl.textContent = 'Request failed';
      } else {
        totalEl.textContent = '—';
        endEl.textContent = '—';
      }
    }

    function setGDP(payload) {
      const g = document.getElementById('gdp');
      const gy = document.getElementById('gdpYear');
      if (payload.status === 'ok') {
        g.textContent = `${fmtMoney(payload.gdpUSD)} USD`;
        gy.textContent = payload.gdpYear ? `Year: ${payload.gdpYear}` : '';
      } else if (payload.status === 'empty') {
        g.textContent = '—';
        gy.textContent = '';
      } else if (payload.status === 'error') {
        g.textContent = 'Request failed';
        gy.textContent = '';
      } else {
        g.textContent = '—';
        gy.textContent = '';
      }
    }

    function setPopulation(payload) {
      const p = document.getElementById('population');
      const py = document.getElementById('popYear');
      if (payload.status === 'ok') {
        p.textContent = fmtInt(payload.population);
        py.textContent = payload.popYear ? `Year: ${payload.popYear}` : '';
      } else if (payload.status === 'empty') {
        p.textContent = '—';
        py.textContent = '';
      } else if (payload.status === 'error') {
        p.textContent = 'Request failed';
        py.textContent = '';
      } else {
        p.textContent = '—';
        py.textContent = '';
      }
    }

    function drawEndemicChart(total, endangered) {
      const cont = d3.select('#chart');
      cont.selectAll('*').remove();
      const W = 300, H = 160, M = { t:10, r:12, b:26, l:42 };
      const data = [
        { k: 'Endemic', v: +total || 0 },
        { k: 'Endangered endemic', v: +endangered || 0 }
      ];
      const svgC = cont.append('svg').attr('width', W).attr('height', H);
      const x = d3.scaleBand().domain(data.map(d=>d.k)).range([M.l, W - M.r]).padding(0.35);
      const y = d3.scaleLinear().domain([0, d3.max(data, d=>d.v)||1]).nice().range([H - M.b, M.t]);

      svgC.append('g')
        .selectAll('rect')
        .data(data)
        .join('rect')
        .attr('x', d=>x(d.k))
        .attr('y', d=>y(d.v))
        .attr('width', x.bandwidth())
        .attr('height', d=>y(0) - y(d.v))
        .attr('fill', (d,i)=> i===0 ? '#6fb1ff' : '#9ad98b');

      const ax = d3.axisBottom(x);
      const ay = d3.axisLeft(y).ticks(5).tickFormat(d3.format('.2s'));

      svgC.append('g').attr('transform', `translate(0,${H - M.b})`).call(ax)
        .selectAll('text').style('fill','#a8b3c7').style('font-size','11px');
      svgC.append('g').attr('transform', `translate(${M.l},0)`).call(ay)
        .call(g=>g.selectAll('text').style('fill','#a8b3c7').style('font-size','11px'))
        .call(g=>g.selectAll('line,path').attr('stroke','#2a3666'));
    }

    // Boot: draw map (tables load on first click; you can also preload here if you prefer)
    (async function init() {
      await drawMap();
      // Optional eager preload to make first click instant:
      // showLoading(true);
      // try { await preloadAllTables(); } finally { showLoading(false); }
      // Optionally preload a country:
      // handleCountryClick({ id: 528, properties: { name: 'Netherlands' } });
    })();
  </script>
</body>
</html>
