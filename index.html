<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Highlighting the correlation between endangered species and country socioeconomic profile.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1020; --ink:#f2f4f8; --accent:#6fb1ff; --muted:#a8b3c7; --panel:#121831; }

    html,body {
      margin:0;
      height:100%;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }

    body {
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    header {
      padding:12px 24px;
      border-bottom:1px solid #1e2748;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      background:rgba(5,8,20,0.9);
      backdrop-filter:blur(10px);
    }

    h1 {
      margin:0;
      font-size:18px;
      line-height:1.3;
    }

    /* Top nav */
    .nav {
      display:flex;
      gap:8px;
    }
    .nav button {
      background:transparent;
      border:1px solid transparent;
      color:var(--muted);
      padding:6px 12px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      transition:background .15s, color .15s, border-color .15s;
    }
    .nav button:hover {
      border-color:#28345c;
      background:#151b35;
      color:var(--ink);
    }
    .nav button.active {
      background:var(--accent);
      color:#050816;
      border-color:var(--accent);
    }

    /* Page system */
    .page {
      display:none;
      flex:1;
      padding:24px;
      box-sizing:border-box;
    }
    .page.active {
      display:block;
    }

    /* Map layout (your original) */
    .app {
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap:0;
      min-height:calc(100vh - 80px);
    }
    .map-wrap { position:relative; }
    .map { width:100%; height:100%; }
    .sidebar {
      background:var(--panel);
      border-left:1px solid #1e2748;
      padding:18px;
      overflow:auto;
    }
    .sidebar h2 { font-size:16px; margin:0 0 8px; }
    .sidebar .small { color:var(--muted); font-size:12px; }
    .metric { margin:14px 0; }
    .metric-label {
      color:var(--muted);
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.04em;
    }
    .metric-value { font-size:20px; margin-top:4px; }
    .loading {
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      background:transparent;
    }
    .spinner {
      width:42px;
      height:42px;
      border:4px solid #33406a;
      border-top-color:var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    .tooltip {
      position:absolute;
      pointer-events:none;
      background:#0e1530;
      color:var(--ink);
      padding:6px 8px;
      border:1px solid #1f2a50;
      border-radius:6px;
      font-size:12px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      opacity:0;
      transition:opacity .15s;
    }
    .note { margin-top:10px; color:var(--muted); font-size:12px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .legend { margin:10px 0 2px; font-size:12px; color:var(--muted); }
    .attribution { margin-top:8px; font-size:11px; color:var(--muted); }
    a, a:visited { color:var(--accent); text-decoration:none; }
    a:hover { text-decoration:underline; }
    .status { font-size:12px; color:var(--muted); margin-top:4px; }
    .err { color:#ff9aa2; }

    /* Simple Home & Contact styling */
    .hero {
      max-width:720px;
    }
    .hero h2 {
      margin-top:0;
      font-size:24px;
    }
    .hero p {
      color:var(--muted);
      line-height:1.6;
    }
    .cards {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:16px;
      margin-top:24px;
      max-width:900px;
    }
    .card {
      background:var(--panel);
      border-radius:14px;
      padding:16px 18px;
      border:1px solid #1e2748;
      font-size:14px;
      color:var(--muted);
    }
    .card h3 {
      margin:0 0 6px;
      font-size:16px;
      color:var(--ink);
    }

    .contact-box {
      max-width:520px;
      background:var(--panel);
      border-radius:16px;
      border:1px solid #1e2748;
      padding:18px 20px;
      font-size:14px;
      color:var(--muted);
    }
    .contact-box h2 {
      margin-top:0;
      font-size:20px;
      color:var(--ink);
    }

    @media (max-width:900px) {
      .app {
        grid-template-columns:1fr;
        min-height:auto;
      }
    }
  </style>
</head>
<body>

  <header>
    <h1>Highlighting the correlation between endangered species and the economic growth of countries</h1>
    <nav class="nav">
      <button class="nav-link active" data-page="home">Home</button>
      <button class="nav-link" data-page="map">Map</button>
      <button class="nav-link" data-page="contact">Contact</button>
    </nav>
  </header>

  <!-- HOME PAGE -->
  <section id="home" class="page active">
    <div class="hero">
      <h2>Welcome to the Endangered Species & Economy Explorer</h2>
      <p>
        This tool lets you explore how biodiversity (endemic and endangered species)
        relates to the economic profile of countries (GDP and population).
        Use the <strong>Map</strong> tab above to interact with the data.
      </p>
      <p>
        Click on any country on the map to see:
      </p>
      <ul>
        <li>Total endemic species</li>
        <li>Endangered endemic species</li>
        <li>Latest nominal GDP (USD)</li>
        <li>Latest population</li>
      </ul>
    </div>

    <div class="cards">
      <div class="card">
        <h3>Why this matters</h3>
        <p>
          Biodiversity loss and economic development are deeply connected.
          Visualising both helps highlight trade-offs and potential synergies for policy makers.
        </p>
      </div>
      <div class="card">
        <h3>How to use the map</h3>
        <p>
          Go to the <strong>Map</strong> tab, hover to see country names  
          and click a country to load its biodiversity and socioeconomic data from QLever/Wikidata.
        </p>
      </div>
      <div class="card">
        <h3>Data sources</h3>
        <p>
          All data is retrieved live from Wikidata via QLever and displayed using D3 and a
          TopoJSON world map.
        </p>
      </div>
    </div>
  </section>

  <!-- MAP PAGE (your original app) -->
  <section id="map" class="page">
    <div class="app">
      <div class="map-wrap">
        <svg class="map"></svg>
        <div class="loading" id="loading" aria-hidden="true" style="display:none;">
          <div class="spinner"></div>
        </div>
        <div class="tooltip" id="tooltip"></div>
      </div>
      <aside class="sidebar">
        <h2 id="country-title">Click a country</h2>
        <div class="small">The panel will show:
          <ul>
            <li>Total endemic species</li>
            <li>Endangered endemic species</li>
            <li>Latest nominal GDP (USD)</li>
            <li>Latest population</li>
          </ul>
        </div>

        <div class="metric">
          <div class="metric-label">Total endemic species</div>
          <div class="metric-value" id="totalEndemic">—</div>
          <div class="status" id="endemicStatus"></div>
        </div>
        <div class="metric">
          <div class="metric-label">Endangered endemic species</div>
          <div class="metric-value" id="endangeredEndemic">—</div>
        </div>

        <div id="chart" style="margin:10px 0 6px;"></div>
        <div class="legend">Bar chart: endemic vs. endangered endemic</div>

        <div class="metric" style="margin-top:18px;">
          <div class="metric-label">Latest nominal GDP (USD)</div>
          <div class="metric-value" id="gdp">—</div>
          <div class="small" id="gdpYear"></div>
          <div class="status" id="gdpStatus"></div>
        </div>

        <div class="metric">
          <div class="metric-label">Latest population</div>
          <div class="metric-value" id="population">—</div>
          <div class="small" id="popYear"></div>
          <div class="status" id="popStatus"></div>
        </div>

        <div class="note">Data source: QLever Wikidata (live). Served once, filtered client-side per click.</div>
        <div class="attribution">
          Map © <a href="https://github.com/topojson/world-atlas" target="_blank" rel="noopener">world-atlas</a>
          · Built with <a href="https://d3js.org/" target="_blank" rel="noopener">D3</a>.
        </div>
      </aside>
    </div>
  </section>

  <!-- CONTACT PAGE -->
  <section id="contact" class="page">
    <div class="contact-box">
      <h2>Contact</h2>
      <p>
        This prototype is an exploratory data-visualisation project on endangered species
        and country socioeconomic profiles.
      </p>
      <p>
        If you have feedback, ideas for new indicators, or you spot a data issue in Wikidata,
        feel free to reach out or open an issue in the project repository (if hosted on GitHub).
      </p>
      <p>
        You can also:
      </p>
      <ul>
        <li>Extend the code with new charts (e.g. CO₂ emissions, protected areas).</li>
        <li>Connect it to your own SPARQL / QLever queries.</li>
        <li>Embed the map into teaching material about biodiversity & economics.</li>
      </ul>
    </div>
  </section>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <script>
    // --- Simple SPA navigation ---
    const pages = document.querySelectorAll('.page');
    const navLinks = document.querySelectorAll('.nav-link');

    function showPage(pageId) {
      pages.forEach(p => {
        p.classList.toggle('active', p.id === pageId);
      });
      navLinks.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.page === pageId);
      });
      if (pageId === 'map') {
        initMapOnce();
      }
    }

    navLinks.forEach(btn => {
      btn.addEventListener('click', () => {
        showPage(btn.dataset.page);
      });
    });

    // --- Your original map / data code, adapted to lazy init ---

    // QLever endpoint (GET ?query=...)
    const QLEVER = 'https://qlever.dev/api/wikidata';
    const ACCEPT_JSON = { 'Accept': 'application/sparql-results+json' };
    const worldUrl = 'https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json';

    const fmtInt = d3.format(',d');
    const fmtMoney = d3.format('~s');

    const $loading = document.getElementById('loading');
    const $tooltip = document.getElementById('tooltip');
    const panelModeEl = document.getElementById('panelMode');
    const dataContextEl = document.getElementById('dataContext');
    const backBtn = document.getElementById('backToWorld');
    const startBtn = document.getElementById('startExploring');

    let endemicTable = null;
    let gdpTable = null;
    let populationTable = null;
    let preloadError = null;

    let worldTopo = null;
    let countries = [];
    let continents = [];
    const continentByCountryId = new Map();
    const countriesByContinent = new Map();

    const state = {
      continentName: null,
      countryId: null
    };

    let projection = null;
    let path = null;
    let rootLayer = null;
    let sphereLayer = null;
    let continentLayer = null;
    let countryLayer = null;
    let borderLayer = null;
    let zoomBehavior = null;
    let currentTransform = d3.zoomIdentity;
    let resizeTimer = null;
    let inFlight = false;

    const svg = d3.select('.map');
    const mapWrap = document.querySelector('.map-wrap');

    function setupButtons() {
      startBtn?.addEventListener('click', () => {
        document.getElementById('explorer').scrollIntoView({ behavior: 'smooth' });
      });
      backBtn?.addEventListener('click', () => { resetToContinents(); });
    }

    function resize() {
      const w = mapWrap.clientWidth || 800;
      const h = Math.max(460, window.innerHeight - 220);
      return { w, h };
    }

    async function loadGeoData() {
      worldTopo = await d3.json(worldUrl);
      countries = topojson.feature(worldTopo, worldTopo.objects.countries).features;
      assignContinents();
    }

    const NAME_OVERRIDES = new Map([
      // Europe/Asia junctions
      ['Türkiye', 'Europe'],
      ['Turkey', 'Europe'],
      ['Cyprus', 'Europe'],
      ['Georgia', 'Europe'],
      ['Kazakhstan', 'Asia'],
      ['Azerbaijan', 'Asia'],
      ['Armenia', 'Asia'],

      // Africa exceptions
      ['Egypt', 'Africa'],
      ['Madagascar', 'Africa'],
      ['Cabo Verde', 'Africa'],
      ['Seychelles', 'Africa'],
      ['Mauritius', 'Africa'],

      // Americas (Caribbean + Central)
      ['Greenland', 'North America'],
      ['Mexico', 'North America'],
      ['Guatemala', 'North America'],
      ['Belize', 'North America'],
      ['El Salvador', 'North America'],
      ['Honduras', 'North America'],
      ['Nicaragua', 'North America'],
      ['Costa Rica', 'North America'],
      ['Panama', 'North America'],
      ['Cuba', 'North America'],
      ['Jamaica', 'North America'],
      ['Haiti', 'North America'],
      ['Dominican Republic', 'North America'],
      ['Bahamas', 'North America'],
      ['The Bahamas', 'North America'],
      ['Barbados', 'North America'],
      ['Trinidad and Tobago', 'North America'],
      ['Grenada', 'North America'],
      ['Saint Lucia', 'North America'],
      ['Saint Vincent and the Grenadines', 'North America'],
      ['Dominica', 'North America'],
      ['Antigua and Barbuda', 'North America'],
      ['Saint Kitts and Nevis', 'North America'],
      ['Puerto Rico', 'North America'],

      // Middle East / Arabian Peninsula
      ['Saudi Arabia', 'Asia'],
      ['United Arab Emirates', 'Asia'],
      ['Oman', 'Asia'],
      ['Yemen', 'Asia'],
      ['Qatar', 'Asia'],
      ['Bahrain', 'Asia'],
      ['Kuwait', 'Asia'],
      ['Israel', 'Asia'],
      ['Lebanon', 'Asia'],
      ['Jordan', 'Asia'],
      ['State of Palestine', 'Asia'],

      // Oceania islands
      ['Papua New Guinea', 'Oceania'],
      ['New Caledonia', 'Oceania'],
      ['New Zealand', 'Oceania'],
      ['Fiji', 'Oceania'],
      ['Solomon Islands', 'Oceania'],
      ['Vanuatu', 'Oceania'],
      ['Samoa', 'Oceania'],
      ['Tonga', 'Oceania'],
      ['Kiribati', 'Oceania'],
      ['Micronesia', 'Oceania'],
      ['Palau', 'Oceania'],
      ['Marshall Islands', 'Oceania'],
      ['Nauru', 'Oceania'],
      ['Tuvalu', 'Oceania'],

      // South / Southeast Asia islands
      ['Timor-Leste', 'Asia'],
      ['Indonesia', 'Asia'],
      ['Philippines', 'Asia'],
      ['Japan', 'Asia'],
      ['Sri Lanka', 'Asia'],

      // Polar territories
      ['French Southern Territories', 'Antarctica']
    ]);

    function assignContinents() {
      continentByCountryId.clear();
      countriesByContinent.clear();
      const buckets = new Map();
      const geometries = worldTopo?.objects?.countries?.geometries || [];
      countries.forEach((feature, index) => {
        const continent = inferContinent(feature) || 'Unassigned';
        feature.properties = feature.properties || {};
        feature.properties.continent = continent;
        continentByCountryId.set(feature.id, continent);
        if (continent === 'Unassigned') return;
        if (!countriesByContinent.has(continent)) countriesByContinent.set(continent, []);
        countriesByContinent.get(continent).push(feature);
        if (!buckets.has(continent)) buckets.set(continent, []);
        const geom = geometries[index];
        if (geom) buckets.get(continent).push(geom);
      });

      continents = Array.from(buckets.entries())
        .filter(([name]) => name && name !== 'Unassigned')
        .map(([name, geoms]) => ({
          type: 'Feature',
          properties: { name },
          geometry: topojson.merge(worldTopo, geoms)
        }));
    }

    function inferContinent(feature) {
      const name = feature?.properties?.name;
      if (NAME_OVERRIDES.has(name)) return NAME_OVERRIDES.get(name);
      const [lon, lat] = d3.geoCentroid(feature);
      if (!Number.isFinite(lon) || !Number.isFinite(lat)) return 'Unassigned';
      if (lat <= -50) return 'Antarctica';
      if (lon < -30) {
        return lat >= 15 ? 'North America' : 'South America';
      }
      if (lon >= -25 && lon <= 60 && lat >= 35) return 'Europe';
      if (lon >= -20 && lon <= 52 && lat < 35 && lat > -40 && !(lon > 40 && lat > 20)) return 'Africa';
      if ((lon >= 110 && lat <= -10) || lon >= 150) return 'Oceania';
      if (lon >= 95 && lat <= -15) return 'Oceania';
      if (lon >= 25) return 'Asia';
      if (lat >= 0) return 'Europe';
      return 'Africa';
    }

    function initMapLayers() {
      svg.selectAll('*').remove();
      rootLayer = svg.append('g').attr('class', 'map-root');
      sphereLayer = rootLayer.append('path').attr('class', 'sphere');
      continentLayer = rootLayer.append('g').attr('class', 'continents-layer');
      countryLayer = rootLayer.append('g').attr('class', 'countries-layer');
      borderLayer = rootLayer.append('path').attr('fill', 'none').attr('stroke', '#0f1738').attr('stroke-width', 0.6);
      zoomBehavior = d3.zoom().scaleExtent([1, 8]).on('zoom', (event) => {
        currentTransform = event.transform;
        rootLayer.attr('transform', currentTransform);
      });
      svg.call(zoomBehavior);
    }

    function renderMap() {
      if (!countries.length || !continents.length) return;
      const { w, h } = resize();
      svg.attr('width', w).attr('height', h);
      projection = d3.geoMercator().fitExtent([[10, 10], [w - 10, h - 10]], { type: 'Sphere' });
      path = d3.geoPath(projection);

      sphereLayer.attr('d', path({ type: 'Sphere' }));

      continentLayer.selectAll('path')
        .data(continents, d => d.properties?.name || d.id)
        .join(
          enter => enter.append('path')
            .attr('class', 'continent')
            .attr('d', path)
            .on('mousemove', handleMouseMove)
            .on('mouseleave', handleMouseLeave)
            .on('click', (event, d) => { event.stopPropagation(); handleContinentClick(d); }),
          update => update.attr('d', path),
          exit => exit.remove()
        );

      countryLayer.selectAll('path')
        .data(countries, d => d.id)
        .join(
          enter => enter.append('path')
            .attr('class', 'country')
            .attr('d', path)
            .on('mousemove', handleMouseMove)
            .on('mouseleave', handleMouseLeave)
            .on('click', (event, d) => { event.stopPropagation(); handleCountryClick(d); }),
          update => update.attr('d', path),
          exit => exit.remove()
        );

      const mesh = topojson.mesh(worldTopo, worldTopo.objects.countries, (a, b) => a !== b);
      borderLayer.attr('d', path(mesh));

      rootLayer.attr('transform', currentTransform);
      svg.call(zoomBehavior.transform, currentTransform);
      updateContinentLayerState();
      updateCountryLayerState();
    }

    function handleMouseMove(event, feature) {
      const props = feature?.properties || {};
      const name = props.name || props.admin || props.sovereignt || props.brk_name || `ISO ${feature?.id}`;
      $tooltip.style.opacity = 1;
      $tooltip.style.left = (event.offsetX + 14) + 'px';
      $tooltip.style.top = (event.offsetY + 14) + 'px';
      $tooltip.textContent = name;
    }

    function handleMouseLeave() {
      $tooltip.style.opacity = 0;
    }

    async function handleContinentClick(feature) {
      if (!feature || inFlight) return;
      inFlight = true;
      showLoading(true);
      const contName = feature.properties?.name || 'Selected continent';
      setPanelMode('Continent overview');
      setTitle(contName);
      dataContextEl.textContent = 'Aggregating continent-wide data...';
      toggleBackButton(true);
      try {
        await ensureDataReady();
        if (preloadError) throw preloadError;
        state.continentName = contName;
        state.countryId = null;
        const summary = summarizeContinent(contName);
        updateContinentLayerState();
        updateCountryLayerState();
        zoomToFeature(feature);
        applyContinentSummary(summary, contName);
      } catch (err) {
        console.error(err);
        setAllStatuses('Request failed: unexpected error.');
        dataContextEl.textContent = 'Unable to load continent aggregates right now.';
      } finally {
        showLoading(false);
        inFlight = false;
      }
    }

    async function handleCountryClick(feature) {
      if (!feature || !state.continentName || inFlight) return;
      const contName = continentByCountryId.get(feature.id);
      if (!contName || contName !== state.continentName) return;
      inFlight = true;
      showLoading(true);
      try {
        await ensureDataReady();
        if (preloadError) throw preloadError;
        state.countryId = parseInt(feature.id, 10);
        updateCountryLayerState();
        await hydrateCountryPanel(feature);
        setPanelMode('Country profile');
        dataContextEl.textContent = 'Country-level figures pulled directly from cached Wikidata tables.';
      } catch (err) {
        console.error(err);
        setAllStatuses('Request failed: unexpected error.');
      } finally {
        showLoading(false);
        inFlight = false;
      }
    }

    function summarizeContinent(name) {
      const list = countriesByContinent.get(name) || [];
      const isoList = list.map(c => parseInt(c.id, 10)).filter(Number.isFinite);
      const summary = {
        totalCountries: list.length,
        endemicCount: 0,
        gdpCount: 0,
        popCount: 0,
        totalEndemic: 0,
        endangered: 0,
        gdpUSD: 0,
        population: 0,
        gdpYears: new Set(),
        popYears: new Set()
      };
      for (const iso of isoList) {
        const eRow = endemicTable?.get(iso);
        if (eRow) {
          summary.endemicCount++;
          summary.totalEndemic += eRow.totalEndemicSpecies || 0;
          summary.endangered += eRow.endangeredEndemicSpecies || 0;
        }
        const gRow = gdpTable?.get(iso);
        if (gRow) {
          summary.gdpCount++;
          summary.gdpUSD += gRow.gdpUSD || 0;
          if (gRow.gdpYear) summary.gdpYears.add(gRow.gdpYear);
        }
        const pRow = populationTable?.get(iso);
        if (pRow) {
          summary.popCount++;
          summary.population += pRow.population || 0;
          if (pRow.popYear) summary.popYears.add(pRow.popYear);
        }
      }
      summary.gdpYearNote = formatYearNote(summary.gdpYears);
      summary.popYearNote = formatYearNote(summary.popYears);
      summary.note = summary.totalCountries
        ? `Aggregated from ${summary.totalCountries} countries (${summary.endemicCount || 0} with endemic data).`
        : 'No linked countries found for this continent yet.';
      return summary;
    }

    function formatYearNote(set) {
      if (!set || !set.size) return '';
      const arr = Array.from(set).sort();
      if (arr.length === 1) return `Latest year: ${arr[0]}`;
      return `Latest years: ${arr[0]}–${arr[arr.length - 1]}`;
    }

    function applyContinentSummary(summary, name) {
      setTitle(name);
      if (!summary.totalCountries) {
        clearPanel();
        dataContextEl.textContent = summary.note;
        return;
      }
      if (summary.endemicCount) {
        applyEndemicResult({ status: 'ok', totalEndemicSpecies: summary.totalEndemic, endangeredEndemicSpecies: summary.endangered });
      } else {
        applyEndemicResult({ status: 'empty' });
      }
      if (summary.gdpCount) {
        applyGdpResult({ status: 'ok', gdpUSD: summary.gdpUSD, gdpYear: summary.gdpYearNote });
      } else {
        applyGdpResult({ status: 'empty' });
      }
      if (summary.popCount) {
        applyPopResult({ status: 'ok', population: summary.population, popYear: summary.popYearNote });
      } else {
        applyPopResult({ status: 'empty' });
      }
      const endemicMsg = summary.endemicCount ? `Countries with endemic data: ${summary.endemicCount}` : 'No data';
      const gdpMsg = summary.gdpCount ? `Countries with GDP data: ${summary.gdpCount}` : 'No data';
      const popMsg = summary.popCount ? `Countries with population data: ${summary.popCount}` : 'No data';
      setStatuses(endemicMsg, gdpMsg, popMsg);
      dataContextEl.textContent = `${summary.note} Select a highlighted country within ${name} to drill down.`;
      updateCountryLayerState();
      countryLayer.classed('active', true);
    }

    async function hydrateCountryPanel(feature) {
      const isoNumeric = parseInt(feature.id, 10);
      if (!Number.isFinite(isoNumeric)) return;
      const topoName = (feature.properties || {}).name || feature.properties?.admin || feature.properties?.sovereignt || feature.properties?.brk_name || '';
      const lbl = endemicTable?.get(isoNumeric)?.countryLabel
        || gdpTable?.get(isoNumeric)?.countryLabel
        || populationTable?.get(isoNumeric)?.countryLabel
        || topoName
        || `ISO numeric ${isoNumeric}`;
      setTitle(lbl);

      if (preloadError) {
        setAllStatuses('Request failed: unexpected error.');
        return;
      }

      const endemicRow = endemicTable?.get(isoNumeric);
      if (endemicRow) {
        applyEndemicResult({
          status: 'ok',
          totalEndemicSpecies: endemicRow.totalEndemicSpecies,
          endangeredEndemicSpecies: endemicRow.endangeredEndemicSpecies
        });
      } else {
        applyEndemicResult({ status: 'empty' });
      }

      const gRow = gdpTable?.get(isoNumeric);
      if (gRow) {
        applyGdpResult({ status: 'ok', gdpUSD: gRow.gdpUSD, gdpYear: gRow.gdpYear });
      } else {
        applyGdpResult({ status: 'empty' });
      }

      const pRow = populationTable?.get(isoNumeric);
      if (pRow) {
        applyPopResult({ status: 'ok', population: pRow.population, popYear: pRow.popYear });
      } else {
        applyPopResult({ status: 'empty' });
      }

      setStatuses('', '', '');
    }

    function updateContinentLayerState() {
      if (!continentLayer) return;
      continentLayer.selectAll('path')
        .classed('continent-selected', d => state.continentName && (d.properties?.name === state.continentName))
        .classed('continent-dim', d => state.continentName && (d.properties?.name !== state.continentName));
    }

    function updateCountryLayerState() {
      if (!countryLayer) return;
      const active = Boolean(state.continentName);
      countryLayer.classed('active', active);
      countryLayer.selectAll('path')
        .classed('country-muted', d => active && continentByCountryId.get(d.id) !== state.continentName)
        .classed('country-selected', d => state.countryId === parseInt(d.id, 10));
    }

    function zoomToFeature(feature) {
      if (!feature || !path) return;
      const [[x0, y0], [x1, y1]] = path.bounds(feature);
      const w = parseFloat(svg.attr('width')) || 800;
      const h = parseFloat(svg.attr('height')) || 500;
      const dx = x1 - x0;
      const dy = y1 - y0;
      const x = (x0 + x1) / 2;
      const y = (y0 + y1) / 2;
      const scale = Math.min(8, 0.85 / Math.max(dx / w, dy / h));
      const translate = [w / 2 - scale * x, h / 2 - scale * y];
      svg.transition().duration(850).call(
        zoomBehavior.transform,
        d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
      );
    }

    function resetZoom() {
      svg.transition().duration(650).call(zoomBehavior.transform, d3.zoomIdentity);
    }

    function resetToContinents() {
      state.continentName = null;
      state.countryId = null;
      setPanelMode('Continent overview');
      setTitle('Select a continent');
      dataContextEl.textContent = 'Select a continent to see aggregated totals.';
      clearPanel();
      updateContinentLayerState();
      updateCountryLayerState();
      toggleBackButton(false);
      countryLayer?.classed('active', false);
      resetZoom();
    }

    function toggleBackButton(active) {
      if (backBtn) backBtn.disabled = !active;
    }

    function onResize() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        renderMap();
      }, 150);
    }

    async function ensureDataReady() {
      if (endemicTable && gdpTable && populationTable) return;
      try {
        await preloadAllTables();
      } catch (err) {
        preloadError = err;
        throw err;
      }
    }

    async function preloadAllTables() {
      const endData = await runSparqlGETWithRetry(Q_END_EMD);
      endemicTable = buildEndemicMap(endData);

      const gdpData = await runSparqlGETWithRetry(Q_GDP);
      gdpTable = buildGdpMap(gdpData);

      const popData = await runSparqlGETWithRetry(Q_POP);
      populationTable = buildPopulationMap(popData);
    }

    async function runSparqlGETWithRetry(query, { retries = 3, baseDelayMs = 400 } = {}) {
      let attempt = 0;
      while (true) {
        try {
          const url = QLEVER + '?query=' + encodeURIComponent(query);
          const res = await fetch(url, { method: 'GET', headers: ACCEPT_JSON });
          if (!res.ok) {
            if ((res.status === 429 || res.status === 403 || res.status === 503) && attempt < retries) {
              attempt++;
              await delayWithJitter(baseDelayMs, attempt);
              continue;
            }
            throw new Error(`QLever error ${res.status}`);
          }
          return await res.json();
        } catch (e) {
          if (attempt < retries) {
            attempt++;
            await delayWithJitter(baseDelayMs, attempt);
            continue;
          }
          throw e;
        }
      }
    }

    function delayWithJitter(base, attempt) {
      const jitter = Math.random() * 400;
      const wait = Math.min(800, base * attempt) + jitter;
      return new Promise(r => setTimeout(r, wait));
    }

    // ---------- EXACT QUERIES ----------
    const Q_END_EMD = `
PREFIX wd:   <http://www.wikidata.org/entity/>
PREFIX wdt:  <http://www.wikidata.org/prop/direct/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT
  ?country
  ?countryLabel
  ?iso3
  ?isoNum
  (COALESCE(?allSpecies, 0)        AS ?totalEndemicSpecies)
  (COALESCE(?endangeredSpecies, 0) AS ?endangeredEndemicSpecies)
WHERE {
  ?country wdt:P31 wd:Q6256 .
  OPTIONAL { ?country rdfs:label ?countryLabel . FILTER(LANG(?countryLabel) = "en") }
  OPTIONAL { ?country wdt:P298 ?iso3 }
  OPTIONAL { ?country wdt:P299 ?isoNum }

  OPTIONAL {
    SELECT ?country (COUNT(DISTINCT ?sp) AS ?allSpecies)
    WHERE {
      ?sp wdt:P31 wd:Q16521 ;
          wdt:P105 wd:Q7432 ;
          wdt:P183 ?country .
      ?country wdt:P31 wd:Q6256 .
    }
    GROUP BY ?country
  }

  OPTIONAL {
    SELECT ?country (COUNT(DISTINCT ?sp2) AS ?endangeredSpecies)
    WHERE {
      ?sp2 wdt:P31  wd:Q16521 ;
           wdt:P105 wd:Q7432 ;
           wdt:P141 wd:Q96377276 ;
           wdt:P183 ?country .
      ?country wdt:P31 wd:Q6256 .
    }
    GROUP BY ?country
  }
}
ORDER BY DESC(?totalEndemicSpecies)
`;

    const Q_GDP = `
PREFIX wd:   <http://www.wikidata.org/entity/>
PREFIX wdt:  <http://www.wikidata.org/prop/direct/>
PREFIX p:    <http://www.wikidata.org/prop/>
PREFIX ps:   <http://www.wikidata.org/prop/statement/>
PREFIX pq:   <http://www.wikidata.org/prop/qualifier/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT
  ?country
  ?countryLabel
  ?iso3
  ?isoNum
  ?gdpUSD
  ?gdpYear
WHERE {
  ?country wdt:P31 wd:Q6256 .
  OPTIONAL { ?country rdfs:label ?countryLabel . FILTER(LANG(?countryLabel) = "en") }
  OPTIONAL { ?country wdt:P298 ?iso3 }
  OPTIONAL { ?country wdt:P299 ?isoNum }

  {
    SELECT ?country (MAX(?date) AS ?latestDate)
    WHERE {
      ?country wdt:P31 wd:Q6256 ;
               p:P2131 ?st .
      ?st pq:P585 ?date .
    }
    GROUP BY ?country
  }

  ?country p:P2131 ?st2 .
  ?st2 pq:P585 ?latestDate ;
       ps:P2131 ?gdpUSD .
  BIND(YEAR(?latestDate) AS ?gdpYear)
}
ORDER BY DESC(?gdpUSD)
`;

    const Q_POP = `
PREFIX wd:   <http://www.wikidata.org/entity/>
PREFIX wdt:  <http://www.wikidata.org/prop/direct/>
PREFIX p:    <http://www.wikidata.org/prop/>
PREFIX ps:   <http://www.wikidata.org/prop/statement/>
PREFIX pq:   <http://www.wikidata.org/prop/qualifier/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

SELECT
  ?country
  ?countryLabel
  ?iso3
  ?isoNum
  ?population
  ?popYear
WHERE {
  ?country wdt:P31 wd:Q6256 .
  OPTIONAL { ?country rdfs:label ?countryLabel . FILTER(LANG(?countryLabel) = "en") }
  OPTIONAL { ?country wdt:P298 ?iso3 }
  OPTIONAL { ?country wdt:P299 ?isoNum }

  {
    SELECT ?country (MAX(?date) AS ?latestDate)
    WHERE {
      ?country wdt:P31 wd:Q6256 ;
               p:P1082 ?popStmt .
      ?popStmt pq:P585 ?date .
    }
    GROUP BY ?country
  }

  ?country p:P1082 ?popStmt2 .
  ?popStmt2 pq:P585 ?latestDate ;
            ps:P1082 ?population .
  BIND(YEAR(?latestDate) AS ?popYear)
}
ORDER BY DESC(?population)
`;

    // ---------- Preload: run the 3 queries once, build fast lookup maps ----------
    async function preloadAllTables() {
      const endData = await runSparqlGETWithRetry(Q_END_EMD);
      endemicTable = buildEndemicMap(endData);

      const gdpData = await runSparqlGETWithRetry(Q_GDP);
      gdpTable = buildGdpMap(gdpData);

      const popData = await runSparqlGETWithRetry(Q_POP);
      populationTable = buildPopulationMap(popData);
    }

    function buildEndemicMap(json) {
      const m = new Map();
      const rows = json?.results?.bindings || [];
      for (const r of rows) {
        const isoNumStr = r.isoNum?.value;
        const isoInt = isoNumStr ? parseInt(isoNumStr, 10) : NaN;
        if (!Number.isFinite(isoInt)) continue;
        m.set(isoInt, {
          countryLabel: r.countryLabel?.value || '',
          iso3: r.iso3?.value || '',
          isoNum: isoNumStr,
          totalEndemicSpecies: +(r.totalEndemicSpecies?.value || 0),
          endangeredEndemicSpecies: +(r.endangeredEndemicSpecies?.value || 0)
        });
      }
      return m;
    }

    function buildGdpMap(json) {
      const m = new Map();
      const rows = json?.results?.bindings || [];
      for (const r of rows) {
        const isoNumStr = r.isoNum?.value;
        const isoInt = isoNumStr ? parseInt(isoNumStr, 10) : NaN;
        if (!Number.isFinite(isoInt)) continue;
        m.set(isoInt, {
          countryLabel: r.countryLabel?.value || '',
          iso3: r.iso3?.value || '',
          isoNum: isoNumStr,
          gdpUSD: +(r.gdpUSD?.value || 0),
          gdpYear: r.gdpYear?.value || ''
        });
      }
      return m;
    }

    function buildPopulationMap(json) {
      const m = new Map();
      const rows = json?.results?.bindings || [];
      for (const r of rows) {
        const isoNumStr = r.isoNum?.value;
        const isoInt = isoNumStr ? parseInt(isoNumStr, 10) : NaN;
        if (!Number.isFinite(isoInt)) continue;
        m.set(isoInt, {
          countryLabel: r.countryLabel?.value || '',
          iso3: r.iso3?.value || '',
          isoNum: isoNumStr,
          population: +(r.population?.value || 0),
          popYear: r.popYear?.value || ''
        });
      }
      return m;
    }

    // ---------- Click handling ----------
    let inFlight = false;

    async function handleCountryClick(feature) {
      if (inFlight) return;
      inFlight = true;

      const isoNumeric = parseInt(feature.id, 10);
      showLoading(true);
      clearPanel();

      try {
        if (!endemicTable || !gdpTable || !populationTable) {
          try {
            await preloadAllTables();
          } catch (e) {
            console.error(e);
            preloadError = e;
          }
        }

        const topoName = (feature.properties||{}).name || feature.properties?.admin || feature.properties?.sovereignt || feature.properties?.brk_name || '';
        const lbl = endemicTable?.get(isoNumeric)?.countryLabel
                 || gdpTable?.get(isoNumeric)?.countryLabel
                 || populationTable?.get(isoNumeric)?.countryLabel
                 || topoName
                 || `ISO numeric ${isoNumeric}`;
        setTitle(lbl);

        if (preloadError) {
          applyEndemicResult({ status: 'error' });
        } else {
          const row = endemicTable?.get(isoNumeric);
          if (row) {
            applyEndemicResult({
              status: 'ok',
              totalEndemicSpecies: row.totalEndemicSpecies,
              endangeredEndemicSpecies: row.endangeredEndemicSpecies
            });
          } else {
            applyEndemicResult({ status: 'empty' });
          }
        }

        if (preloadError) {
          applyGdpResult({ status: 'error' });
        } else {
          const row = gdpTable?.get(isoNumeric);
          if (row) {
            applyGdpResult({
              status: 'ok',
              gdpUSD: row.gdpUSD,
              gdpYear: row.gdpYear
            });
          } else {
            applyGdpResult({ status: 'empty' });
          }
        }

        if (preloadError) {
          applyPopResult({ status: 'error' });
        } else {
          const row = populationTable?.get(isoNumeric);
          if (row) {
            applyPopResult({
              status: 'ok',
              population: row.population,
              popYear: row.popYear
            });
          } else {
            applyPopResult({ status: 'empty' });
          }
        }

      } catch (err) {
        console.error(err);
        setAllStatuses('Request failed: unexpected error.');
      } finally {
        showLoading(false);
        inFlight = false;
      }
    }

    // ---------- UI helpers ----------
    function showLoading(on) {
      $loading.style.display = on ? 'flex' : 'none';
      $loading.setAttribute('aria-hidden', on ? 'false' : 'true');
    }

    function setPanelMode(text) {
      panelModeEl.textContent = text;
    }

    function setTitle(text) {
      document.getElementById('country-title').textContent = text || 'Select a continent';
    }

    function clearPanel() {
      setEndemic({ status: null });
      setGDP({ status: null });
      setPopulation({ status: null });
      drawEndemicChart(0, 0);
      setStatuses('', '', '');
    }

    function setStatuses(endemicMsg, gdpMsg, popMsg) {
      const es = document.getElementById('endemicStatus');
      const gs = document.getElementById('gdpStatus');
      const ps = document.getElementById('popStatus');
      es.textContent = endemicMsg || '';
      gs.textContent = gdpMsg || '';
      ps.textContent = popMsg || '';
      [es, gs, ps].forEach(el => el.classList.remove('err'));
    }

    function setAllStatuses(message) {
      const es = document.getElementById('endemicStatus');
      const gs = document.getElementById('gdpStatus');
      const ps = document.getElementById('popStatus');
      [es, gs, ps].forEach(el => { el.textContent = message || ''; el.classList.add('err'); });
    }

    function applyEndemicResult(res) {
      const status = document.getElementById('endemicStatus');
      if (res.status === 'ok') {
        setEndemic(res);
        drawEndemicChart(res.totalEndemicSpecies, res.endangeredEndemicSpecies);
        status.textContent = '';
        status.classList.remove('err');
      } else if (res.status === 'empty') {
        setEndemic({ status: 'empty' });
        drawEndemicChart(0, 0);
        status.textContent = 'No data';
        status.classList.remove('err');
      } else if (res.status === 'error') {
        setEndemic({ status: 'error' });
        drawEndemicChart(0, 0);
        status.textContent = 'Request failed';
        status.classList.add('err');
      } else {
        setEndemic({ status: null });
        drawEndemicChart(0, 0);
        status.textContent = '';
        status.classList.remove('err');
      }
    }

    function applyGdpResult(res) {
      const status = document.getElementById('gdpStatus');
      if (res.status === 'ok') {
        setGDP(res);
        status.textContent = '';
        status.classList.remove('err');
      } else if (res.status === 'empty') {
        setGDP({ status: 'empty' });
        status.textContent = 'No data';
        status.classList.remove('err');
      } else if (res.status === 'error') {
        setGDP({ status: 'error' });
        status.textContent = 'Request failed';
        status.classList.add('err');
      } else {
        setGDP({ status: null });
        status.textContent = '';
        status.classList.remove('err');
      }
    }

    function applyPopResult(res) {
      const status = document.getElementById('popStatus');
      if (res.status === 'ok') {
        setPopulation(res);
        status.textContent = '';
        status.classList.remove('err');
      } else if (res.status === 'empty') {
        setPopulation({ status: 'empty' });
        status.textContent = 'No data';
        status.classList.remove('err');
      } else if (res.status === 'error') {
        setPopulation({ status: 'error' });
        status.textContent = 'Request failed';
        status.classList.add('err');
      } else {
        setPopulation({ status: null });
        status.textContent = '';
        status.classList.remove('err');
      }
    }

    function setEndemic(payload) {
      const totalEl = document.getElementById('totalEndemic');
      const endEl = document.getElementById('endangeredEndemic');
      if (payload.status === 'ok') {
        totalEl.textContent = fmtInt(payload.totalEndemicSpecies);
        endEl.textContent = fmtInt(payload.endangeredEndemicSpecies);
      } else if (payload.status === 'empty') {
        totalEl.textContent = '—';
        endEl.textContent = '—';
      } else if (payload.status === 'error') {
        totalEl.textContent = 'Request failed';
        endEl.textContent = 'Request failed';
      } else {
        totalEl.textContent = '—';
        endEl.textContent = '—';
      }
    }

    function setGDP(payload) {
      const g = document.getElementById('gdp');
      const gy = document.getElementById('gdpYear');
      if (payload.status === 'ok') {
        g.textContent = `${fmtMoney(payload.gdpUSD)} USD`;
        gy.textContent = formatYearLabel(payload.gdpYear);
      } else if (payload.status === 'empty') {
        g.textContent = '—';
        gy.textContent = '';
      } else if (payload.status === 'error') {
        g.textContent = 'Request failed';
        gy.textContent = '';
      } else {
        g.textContent = '—';
        gy.textContent = '';
      }
    }

    function setPopulation(payload) {
      const p = document.getElementById('population');
      const py = document.getElementById('popYear');
      if (payload.status === 'ok') {
        p.textContent = fmtInt(payload.population);
        py.textContent = formatYearLabel(payload.popYear);
      } else if (payload.status === 'empty') {
        p.textContent = '—';
        py.textContent = '';
      } else if (payload.status === 'error') {
        p.textContent = 'Request failed';
        py.textContent = '';
      } else {
        p.textContent = '—';
        py.textContent = '';
      }
    }

    function drawEndemicChart(total, endangered) {
      const cont = d3.select('#chart');
      cont.selectAll('*').remove();
      const W = 300, H = 160, M = { t: 10, r: 12, b: 26, l: 42 };
      const data = [
        { k: 'Endemic', v: +total || 0 },
        { k: 'Endangered endemic', v: +endangered || 0 }
      ];
      const svgC = cont.append('svg').attr('width', W).attr('height', H);
      const x = d3.scaleBand().domain(data.map(d => d.k)).range([M.l, W - M.r]).padding(0.35);
      const y = d3.scaleLinear().domain([0, d3.max(data, d => d.v) || 1]).nice().range([H - M.b, M.t]);

      svgC.append('g')
        .selectAll('rect')
        .data(data)
        .join('rect')
        .attr('x', d => x(d.k))
        .attr('y', d => y(d.v))
        .attr('width', x.bandwidth())
        .attr('height', d => y(0) - y(d.v))
        .attr('fill', (d, i) => i === 0 ? '#6fb1ff' : '#9ad98b');

      const ax = d3.axisBottom(x);
      const ay = d3.axisLeft(y).ticks(5).tickFormat(d3.format('.2s'));

      svgC.append('g').attr('transform', `translate(0,${H - M.b})`).call(ax)
        .selectAll('text').style('fill', '#a8b3c7').style('font-size', '11px');
      svgC.append('g').attr('transform', `translate(${M.l},0)`).call(ay)
        .call(g=>g.selectAll('text').style('fill','#a8b3c7').style('font-size','11px'))
        .call(g=>g.selectAll('line,path').attr('stroke','#2a3666'));
    }

    // Lazy map init: only when you first open "Map"
    let mapInitialized = false;
    async function initMapOnce() {
      if (mapInitialized) return;
      mapInitialized = true;
      await drawMap();
      // Optional eager preload:
      // showLoading(true);
      // try { await preloadAllTables(); } finally { showLoading(false); }
    }

    // Initial state: Home visible (set via HTML classes)
    // No map init here; it waits until "Map" is opened.
  </script>
</body>
</html>
